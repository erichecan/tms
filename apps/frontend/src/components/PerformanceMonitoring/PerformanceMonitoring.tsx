// ÊÄßËÉΩÁõëÊéßÁªÑ‰ª∂
// ÂàõÂª∫Êó∂Èó¥: 2025-09-29 22:00:00
// ‰ΩúÁî®: Á≥ªÁªüÊÄßËÉΩÁõëÊéßÂíåÁºìÂ≠òÁ≠ñÁï•ÁÆ°ÁêÜ

import React, { useState, useEffect } from 'react';
import {
  Card,
  Row,
  Col,
  Button,
  Table,
  Tag,
  Space,
  Typography,
  Progress,
  Alert,
  Modal,
  Form,
  Input,
  Select,
  Switch,
  Slider,
  message,
  Divider,
  Statistic,
  Timeline,
  Tooltip,
  Badge,
  Tabs,
} from 'antd';
import {
  DatabaseOutlined as MemoryOutlined,
  ThunderboltOutlined,
  WarningOutlined,
  CheckCircleOutlined,
  ExclamationCircleOutlined,
  ReloadOutlined,
  SettingOutlined,
  BarChartOutlined,
  MonitorOutlined,
  ApiOutlined,
} from '@ant-design/icons';
import dayjs from 'dayjs';

const { Title, Text } = Typography;
const { Option } = Select;
// const { TabPane } = Tabs; // Â∑≤Â∫üÂºÉÔºåÊîπÁî®itemsÂ±ûÊÄß

interface PerformanceMetric {
  id: string;
  name: string;
  value: number;
  unit: string;
  status: 'good' | 'warning' | 'critical';
  threshold: {
    warning: number;
    critical: number;
  };
  trend: 'up' | 'down' | 'stable';
  lastUpdate: string;
}

interface CacheStatus {
  id: string;
  name: string;
  type: 'redis' | 'memory' | 'database';
  size: number;
  hitRate: number;
  missRate: number;
  status: 'active' | 'inactive' | 'error';
  lastCleanup: string;
}

interface SystemAlert {
  id: string;
  level: 'info' | 'warning' | 'error' | 'critical';
  title: string;
  description: string;
  timestamp: string;
  resolved: boolean;
}

const PerformanceMonitoring: React.FC = () => {
  const [loading, setLoading] = useState(false);
  const [metrics, setMetrics] = useState<PerformanceMetric[]>([]);
  const [cacheStatus, setCacheStatus] = useState<CacheStatus[]>([]);
  const [alerts, setAlerts] = useState<SystemAlert[]>([]);
  const [isConfigModalVisible, setIsConfigModalVisible] = useState(false);
  const [refreshInterval, setRefreshInterval] = useState(30); // Áßí

  useEffect(() => {
    loadPerformanceData();
    
    const interval = setInterval(() => {
      loadPerformanceData();
    }, refreshInterval * 1000);

    return () => clearInterval(interval);
  }, [refreshInterval]);

  const loadPerformanceData = async () => {
    setLoading(true);
    try {
      // Ê®°ÊãüÊÄßËÉΩÊï∞ÊçÆ
      const mockMetrics: PerformanceMetric[] = [
        {
          id: 'CPU',
          name: 'CPU‰ΩøÁî®Áéá',
          value: Math.floor(Math.random() * 40) + 20,
          unit: '%',
          status: Math.random() > 0.8 ? 'warning' : 'good',
          threshold: { warning: 80, critical: 95 },
          trend: 'stable',
          lastUpdate: dayjs().format('HH:mm:ss'),
        },
        {
          id: 'MEMORY',
          name: 'ÂÜÖÂ≠ò‰ΩøÁî®Áéá',
          value: Math.floor(Math.random() * 30) + 40,
          unit: '%',
          status: 'good',
          threshold: { warning: 85, critical: 95 },
          trend: 'up',
          lastUpdate: dayjs().format('HH:mm:ss'),
        },
        {
          id: 'DISK',
          name: 'Á£ÅÁõò‰ΩøÁî®Áéá',
          value: Math.floor(Math.random() * 20) + 60,
          unit: '%',
          status: Math.random() > 0.7 ? 'warning' : 'good',
          threshold: { warning: 80, critical: 90 },
          trend: 'up',
          lastUpdate: dayjs().format('HH:mm:ss'),
        },
        {
          id: 'NETWORK',
          name: 'ÁΩëÁªúÂª∂Ëøü',
          value: Math.floor(Math.random() * 50) + 10,
          unit: 'ms',
          status: 'good',
          threshold: { warning: 100, critical: 200 },
          trend: 'stable',
          lastUpdate: dayjs().format('HH:mm:ss'),
        },
      ];

      const mockCacheStatus: CacheStatus[] = [
        {
          id: 'REDIS',
          name: 'RedisÁºìÂ≠ò',
          type: 'redis',
          size: 128,
          hitRate: 85.5,
          missRate: 14.5,
          status: 'active',
          lastCleanup: dayjs().subtract(2, 'hour').format('HH:mm:ss'),
        },
        {
          id: 'MEMORY',
          name: 'ÂÜÖÂ≠òÁºìÂ≠ò',
          type: 'memory',
          size: 256,
          hitRate: 92.3,
          missRate: 7.7,
          status: 'active',
          lastCleanup: dayjs().subtract(30, 'minute').format('HH:mm:ss'),
        },
        {
          id: 'DB',
          name: 'Êï∞ÊçÆÂ∫ìÊü•ËØ¢ÁºìÂ≠ò',
          type: 'database',
          size: 64,
          hitRate: 78.9,
          missRate: 21.1,
          status: 'active',
          lastCleanup: dayjs().subtract(1, 'hour').format('HH:mm:ss'),
        },
      ];

      const mockAlerts: SystemAlert[] = [
        {
          id: 'A001',
          level: 'warning',
          title: 'ÂÜÖÂ≠ò‰ΩøÁî®ÁéáÂÅèÈ´ò',
          description: 'Á≥ªÁªüÂÜÖÂ≠ò‰ΩøÁî®ÁéáËææÂà∞78%ÔºåÂª∫ËÆÆÂÖ≥Ê≥®',
          timestamp: dayjs().subtract(10, 'minute').format('HH:mm:ss'),
          resolved: false,
        },
        {
          id: 'A002',
          level: 'info',
          title: 'ÁºìÂ≠òÊ∏ÖÁêÜÂÆåÊàê',
          description: 'RedisÁºìÂ≠òÂ∑≤ÊàêÂäüÊ∏ÖÁêÜÔºåÈáäÊîæÁ©∫Èó¥128MB',
          timestamp: dayjs().subtract(2, 'hour').format('HH:mm:ss'),
          resolved: true,
        },
        {
          id: 'A003',
          level: 'error',
          title: 'Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂',
          description: 'Ê£ÄÊµãÂà∞Êï∞ÊçÆÂ∫ìËøûÊé•Ë∂ÖÊó∂ÔºåÂ∑≤Ëá™Âä®ÈáçËøû',
          timestamp: dayjs().subtract(5, 'minute').format('HH:mm:ss'),
          resolved: true,
        },
      ];

      setMetrics(mockMetrics);
      setCacheStatus(mockCacheStatus);
      setAlerts(mockAlerts);
    } catch (error) {
      message.error('Âä†ËΩΩÊÄßËÉΩÊï∞ÊçÆÂ§±Ë¥•');
    } finally {
      setLoading(false);
    }
  };

  const getStatusColor = (status: string) => {
    const colors = {
      good: 'green',
      warning: 'orange',
      critical: 'red',
      active: 'green',
      inactive: 'gray',
      error: 'red',
    };
    return colors[status as keyof typeof colors] || 'default';
  };

  const getStatusText = (status: string) => {
    const texts = {
      good: 'Ê≠£Â∏∏',
      warning: 'Ë≠¶Âëä',
      critical: '‰∏•Èáç',
      active: 'Ê¥ªË∑É',
      inactive: 'ÈùûÊ¥ªË∑É',
      error: 'ÈîôËØØ',
    };
    return texts[status as keyof typeof texts] || status;
  };

  const getAlertLevelColor = (level: string) => {
    const colors = {
      info: 'blue',
      warning: 'orange',
      error: 'red',
      critical: 'red',
    };
    return colors[level as keyof typeof colors] || 'default';
  };

  const getAlertLevelIcon = (level: string) => {
    const icons = {
      info: <CheckCircleOutlined />,
      warning: <ExclamationCircleOutlined />,
      error: <WarningOutlined />,
      critical: <WarningOutlined />,
    };
    return icons[level as keyof typeof icons] || <CheckCircleOutlined />;
  };

  const getTrendIcon = (trend: string) => {
    const icons = {
      up: 'üìà',
      down: 'üìâ',
      stable: '‚û°Ô∏è',
    };
    return icons[trend as keyof typeof icons] || '‚û°Ô∏è';
  };

  const handleClearCache = (cacheId: string) => {
    Modal.confirm({
      title: 'Ê∏ÖÁêÜÁºìÂ≠òÁ°ÆËÆ§',
      content: 'Á°ÆÂÆöË¶ÅÊ∏ÖÁêÜÊ≠§ÁºìÂ≠òÂêóÔºüÊ≠§Êìç‰ΩúÂèØËÉΩÂΩ±ÂìçÁ≥ªÁªüÊÄßËÉΩ„ÄÇ',
      onOk: () => {
        message.success('ÁºìÂ≠òÊ∏ÖÁêÜÂÆåÊàê');
        loadPerformanceData();
      },
    });
  };

  const handleResolveAlert = (alertId: string) => {
    setAlerts(prev => 
      prev.map(alert => 
        alert.id === alertId 
          ? { ...alert, resolved: true }
          : alert
      )
    );
    message.success('ÂëäË≠¶Â∑≤Ëß£ÂÜ≥');
  };

  const metricsColumns = [
    {
      title: 'ÊåáÊ†áÂêçÁß∞',
      dataIndex: 'name',
      key: 'name',
      render: (text: string, record: PerformanceMetric) => (
        <Space>
          <MonitorOutlined />
          <Text strong>{text}</Text>
        </Space>
      ),
    },
    {
      title: 'ÂΩìÂâçÂÄº',
      key: 'value',
      render: (_, record: PerformanceMetric) => (
        <div>
          <Text style={{ fontSize: '16px', fontWeight: 'bold' }}>
            {record.value}{record.unit}
          </Text>
          <div style={{ marginTop: 4 }}>
            {getTrendIcon(record.trend)}
          </div>
        </div>
      ),
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => (
        <Tag color={getStatusColor(status)}>
          {getStatusText(status)}
        </Tag>
      ),
    },
    {
      title: 'ÈòàÂÄº',
      key: 'threshold',
      render: (_, record: PerformanceMetric) => (
        <div>
          <div>Ë≠¶Âëä: {record.threshold.warning}{record.unit}</div>
          <div>‰∏•Èáç: {record.threshold.critical}{record.unit}</div>
        </div>
      ),
    },
    {
      title: '‰ΩøÁî®Áéá',
      key: 'usage',
      render: (_, record: PerformanceMetric) => {
        const percentage = (record.value / record.threshold.critical) * 100;
        return (
          <Progress
            percent={Math.min(percentage, 100)}
            status={
              record.status === 'critical' ? 'exception' :
              record.status === 'warning' ? 'active' : 'normal'
            }
            size="small"
          />
        );
      },
    },
    {
      title: 'ÊúÄÂêéÊõ¥Êñ∞',
      dataIndex: 'lastUpdate',
      key: 'lastUpdate',
      render: (time: string) => (
        <Text type="secondary">{time}</Text>
      ),
    },
  ];

  const cacheColumns = [
    {
      title: 'ÁºìÂ≠òÂêçÁß∞',
      dataIndex: 'name',
      key: 'name',
      render: (text: string, record: CacheStatus) => (
        <Space>
          <DatabaseOutlined />
          <div>
            <div><Text strong>{text}</Text></div>
            <Text type="secondary" style={{ fontSize: '12px' }}>
              {record.type.toUpperCase()}
            </Text>
          </div>
        </Space>
      ),
    },
    {
      title: 'Â§ßÂ∞è',
      dataIndex: 'size',
      key: 'size',
      render: (size: number) => `${size} MB`,
    },
    {
      title: 'ÂëΩ‰∏≠Áéá',
      dataIndex: 'hitRate',
      key: 'hitRate',
      render: (rate: number) => (
        <div>
          <Progress
            percent={rate}
            status={rate >= 90 ? 'success' : rate >= 70 ? 'normal' : 'exception'}
            size="small"
          />
          <Text style={{ fontSize: '12px' }}>{rate}%</Text>
        </div>
      ),
    },
    {
      title: 'Áä∂ÊÄÅ',
      dataIndex: 'status',
      key: 'status',
      render: (status: string) => (
        <Tag color={getStatusColor(status)}>
          {getStatusText(status)}
        </Tag>
      ),
    },
    {
      title: 'ÊúÄÂêéÊ∏ÖÁêÜ',
      dataIndex: 'lastCleanup',
      key: 'lastCleanup',
      render: (time: string) => (
        <Text type="secondary">{time}</Text>
      ),
    },
    {
      title: 'Êìç‰Ωú',
      key: 'actions',
      render: (_, record: CacheStatus) => (
        <Button 
          size="small" 
          onClick={() => handleClearCache(record.id)}
          disabled={record.status !== 'active'}
        >
          Ê∏ÖÁêÜÁºìÂ≠ò
        </Button>
      ),
    },
  ];

  const alertColumns = [
    {
      title: 'Á∫ßÂà´',
      dataIndex: 'level',
      key: 'level',
      render: (level: string) => (
        <Tag color={getAlertLevelColor(level)} icon={getAlertLevelIcon(level)}>
          {level.toUpperCase()}
        </Tag>
      ),
    },
    {
      title: 'Ê†áÈ¢ò',
      dataIndex: 'title',
      key: 'title',
      render: (title: string) => <Text strong>{title}</Text>,
    },
    {
      title: 'ÊèèËø∞',
      dataIndex: 'description',
      key: 'description',
      render: (description: string) => (
        <Text type="secondary">{description}</Text>
      ),
    },
    {
      title: 'Êó∂Èó¥',
      dataIndex: 'timestamp',
      key: 'timestamp',
      render: (time: string) => (
        <Text type="secondary">{time}</Text>
      ),
    },
    {
      title: 'Áä∂ÊÄÅ',
      key: 'status',
      render: (_, record: SystemAlert) => (
        <Tag color={record.resolved ? 'green' : 'orange'}>
          {record.resolved ? 'Â∑≤Ëß£ÂÜ≥' : 'ÂæÖÂ§ÑÁêÜ'}
        </Tag>
      ),
    },
    {
      title: 'Êìç‰Ωú',
      key: 'actions',
      render: (_, record: SystemAlert) => (
        !record.resolved && (
          <Button 
            size="small" 
            onClick={() => handleResolveAlert(record.id)}
          >
            Ê†áËÆ∞Â∑≤Ëß£ÂÜ≥
          </Button>
        )
      ),
    },
  ];

  return (
    <div>
      
      <Card style={{ marginBottom: 24 }}>
        <Row gutter={[16, 16]} align="middle">
          <Col xs={24} sm={12} md={6}>
            <Space>
              <Text strong>Ëá™Âä®Âà∑Êñ∞:</Text>
              <Select
                value={refreshInterval}
                onChange={setRefreshInterval}
                style={{ width: 100 }}
              >
                <Option value={10}>10Áßí</Option>
                <Option value={30}>30Áßí</Option>
                <Option value={60}>1ÂàÜÈíü</Option>
                <Option value={300}>5ÂàÜÈíü</Option>
              </Select>
            </Space>
          </Col>
          <Col xs={24} sm={12} md={6}>
            <Space>
              <Button 
                icon={<ReloadOutlined />}
                onClick={loadPerformanceData}
                loading={loading}
              >
                ÊâãÂä®Âà∑Êñ∞
              </Button>
              <Button 
                icon={<SettingOutlined />}
                onClick={() => setIsConfigModalVisible(true)}
              >
                ÁõëÊéßÈÖçÁΩÆ
              </Button>
            </Space>
          </Col>
        </Row>
      </Card>

      
      <Row gutter={[16, 16]} style={{ marginBottom: 24 }}>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title="Á≥ªÁªüÂÅ•Â∫∑Â∫¶"
              value={85}
              suffix="%"
              prefix={<CheckCircleOutlined />}
              valueStyle={{ color: '#52c41a' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title="Ê¥ªË∑ÉÂëäË≠¶"
              value={alerts.filter(a => !a.resolved).length}
              prefix={<WarningOutlined />}
              valueStyle={{ color: '#f5222d' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title="ÁºìÂ≠òÂëΩ‰∏≠Áéá"
              value={cacheStatus.reduce((acc, cache) => acc + cache.hitRate, 0) / cacheStatus.length}
              suffix="%"
              prefix={<ThunderboltOutlined />}
              valueStyle={{ color: '#1890ff' }}
            />
          </Card>
        </Col>
        <Col xs={24} sm={12} md={6}>
          <Card>
            <Statistic
              title="Âπ≥ÂùáÂìçÂ∫îÊó∂Èó¥"
              value={metrics.find(m => m.id === 'NETWORK')?.value || 0}
              suffix="ms"
              prefix={<ApiOutlined />}
              valueStyle={{ color: '#722ed1' }}
            />
          </Card>
        </Col>
      </Row>

      
      <Tabs 
        defaultActiveKey="metrics"
        items={[
          {
            key: "metrics",
            label: "ÊÄßËÉΩÊåáÊ†á",
            children: (
              <Card title="Á≥ªÁªüÊÄßËÉΩÊåáÊ†á" extra={<MonitorOutlined />}>
                <Table
                  columns={metricsColumns}
                  dataSource={metrics}
                  rowKey="id"
                  loading={loading}
                  pagination={false}
                />
              </Card>
            )
          },
          {
            key: "cache",
            label: "ÁºìÂ≠òÁä∂ÊÄÅ",
            children: (
              <Card title="ÁºìÂ≠òÁ≥ªÁªüÁä∂ÊÄÅ" extra={<MemoryOutlined />}>
                <Table
                  columns={cacheColumns}
                  dataSource={cacheStatus}
                  rowKey="id"
                  loading={loading}
                  pagination={false}
                />
              </Card>
            )
          },
          {
            key: "alerts",
            label: "Á≥ªÁªüÂëäË≠¶",
            children: (
              <Card title="Á≥ªÁªüÂëäË≠¶" extra={<ExclamationCircleOutlined />}>
                <Table
                  columns={alertColumns}
                  dataSource={alerts}
                  rowKey="id"
                  loading={loading}
                  pagination={{ pageSize: 10 }}
                />
              </Card>
            )
          }
        ]}
      />

      
      <Modal
        title="ÁõëÊéßÈÖçÁΩÆ"
        open={isConfigModalVisible}
        onCancel={() => setIsConfigModalVisible(false)}
        footer={null}
        width={600}
      >
        <Form layout="vertical">
          <Form.Item label="CPUÂëäË≠¶ÈòàÂÄº">
            <Row gutter={16}>
              <Col span={12}>
                <Text>Ë≠¶ÂëäÈòàÂÄº</Text>
                <InputNumber
                  style={{ width: '100%', marginTop: 4 }}
                  min={50}
                  max={100}
                  defaultValue={80}
                  suffix="%"
                />
              </Col>
              <Col span={12}>
                <Text>‰∏•ÈáçÈòàÂÄº</Text>
                <InputNumber
                  style={{ width: '100%', marginTop: 4 }}
                  min={80}
                  max={100}
                  defaultValue={95}
                  suffix="%"
                />
              </Col>
            </Row>
          </Form.Item>

          <Form.Item label="ÂÜÖÂ≠òÂëäË≠¶ÈòàÂÄº">
            <Row gutter={16}>
              <Col span={12}>
                <Text>Ë≠¶ÂëäÈòàÂÄº</Text>
                <InputNumber
                  style={{ width: '100%', marginTop: 4 }}
                  min={50}
                  max={100}
                  defaultValue={85}
                  suffix="%"
                />
              </Col>
              <Col span={12}>
                <Text>‰∏•ÈáçÈòàÂÄº</Text>
                <InputNumber
                  style={{ width: '100%', marginTop: 4 }}
                  min={80}
                  max={100}
                  defaultValue={95}
                  suffix="%"
                />
              </Col>
            </Row>
          </Form.Item>

          <Form.Item label="ÁºìÂ≠òÈÖçÁΩÆ">
            <Space direction="vertical" style={{ width: '100%' }}>
              <Switch defaultChecked>ÂêØÁî®Ëá™Âä®ÁºìÂ≠òÊ∏ÖÁêÜ</Switch>
              <Switch defaultChecked>ÂêØÁî®ÁºìÂ≠òÈ¢ÑÁÉ≠</Switch>
              <Switch>ÂêØÁî®ÁºìÂ≠òÂéãÁº©</Switch>
            </Space>
          </Form.Item>

          <Form.Item label="ÂëäË≠¶ÈÄöÁü•">
            <Space direction="vertical" style={{ width: '100%' }}>
              <Switch defaultChecked>ÈÇÆ‰ª∂ÈÄöÁü•</Switch>
              <Switch defaultChecked>Áü≠‰ø°ÈÄöÁü•</Switch>
              <Switch>ÈíâÈíâÈÄöÁü•</Switch>
            </Space>
          </Form.Item>
        </Form>
      </Modal>
    </div>
  );
};

export default PerformanceMonitoring;
