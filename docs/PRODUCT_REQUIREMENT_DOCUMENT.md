# æ™ºèƒ½ç‰©æµè¿è¥å¹³å° (TMS SaaS) - äº§å“éœ€æ±‚æ–‡æ¡£ (PRD)

**ç‰ˆæœ¬:** 3.1-PC (æ™ºèƒ½è®¡è´¹è§„åˆ™å¼•æ“å®Œæ•´ç‰ˆ)  
**æœ€åæ›´æ–°:** 2025-09-29 09:12:36  

## ç‰ˆæœ¬å˜æ›´æ‘˜è¦ (3.0-PC â†’ 3.1-PC)

å˜æ›´ç‚¹ | è¯´æ˜
-------|-----
**ğŸ¯ æ™ºèƒ½è®¡è´¹è§„åˆ™å¼•æ“å®Œæ•´å®ç°** | ä»é¢„ç•™çŠ¶æ€å‡çº§ä¸ºå®Œæ•´åŠŸèƒ½ï¼Œæ”¯æŒå‘å¯¼å¼è§„åˆ™åˆ›å»ºã€æ¨¡æ¿ç®¡ç†ã€å®æ—¶è®¡ç®—
**ğŸ“Š è®¡è´¹è§„åˆ™ç®¡ç†é¡µé¢** | æ–°å¢4ä¸ªä¸“ç”¨é¡µé¢ï¼šè®¡è´¹é¦–é¡µã€è§„åˆ™å‘å¯¼ã€æ¨¡æ¿ç®¡ç†ã€è®¡ç®—å™¨
**ğŸ”§ åç«¯APIå®Œæ•´æ”¯æŒ** | å®ç°å®Œæ•´çš„è®¡è´¹è§„åˆ™å¼•æ“APIï¼šæ¨¡æ¿CRUDã€è§„åˆ™æ‰§è¡Œã€è®¡ç®—é¢„è§ˆ
**ğŸ’¾ æ•°æ®åº“æ‰©å±•** | æ–°å¢è®¡è´¹è§„åˆ™ç›¸å…³è¡¨ç»“æ„ï¼Œæ”¯æŒè§„åˆ™ç‰ˆæœ¬ç®¡ç†å’Œæ‰§è¡Œå†å²
**ğŸ¨ ç•Œé¢é›†æˆä¼˜åŒ–** | è®¡è´¹åŠŸèƒ½æ— ç¼é›†æˆåˆ°å·¦ä¾§å¯¼èˆªç³»ç»Ÿï¼Œä¿æŒç•Œé¢ä¸€è‡´æ€§

## ç‰ˆæœ¬å˜æ›´æ‘˜è¦ (2.1 â†’ 3.0-PC)

å˜æ›´ç‚¹ | è¯´æ˜
-------|-----
æ–°å¢é¦–é¡µä¸‰å¤§æ¨¡å—å…¥å£ | åˆ›å»ºè¿å•ã€è½¦é˜Ÿç®¡ç†ã€è´¢åŠ¡ç»“ç®—ï¼ˆè´¢åŠ¡ä»…å…¥å£ä¸åˆ—è¡¨åˆç‰ˆï¼‰
å®Œå–„å®¢æˆ·ç®¡ç†åŠŸèƒ½ | æ–°å¢/ç¼–è¾‘/æŸ¥çœ‹ã€å®¢æˆ·è¯¦æƒ…é¡µã€å®¢æˆ·å†å²è¿å•åˆ—è¡¨ã€è´¢åŠ¡ç»“ç®—åˆ—è¡¨å…¥å£
å¼•å…¥è¡Œç¨‹ï¼ˆTripï¼‰æ¦‚å¿µ | æ”¯æŒä¸€ä¸ªè¡Œç¨‹æŒ‚è½½å¤šä¸ªè¿å•ï¼Œè”ç¨‹/å¤šæ®µï¼Œé™ä½ç©ºé©¶ç‡
ä¼˜åŒ–è°ƒåº¦åˆ†é…é€»è¾‘ | è¿å•è¯¦æƒ…é¡µå¯è§†åŒ–å¸æœº/è½¦è¾†å¯ç”¨åˆ—è¡¨ï¼Œæ”¯æŒç›´æ¥æŒ‡æ´¾æˆ–æŒ‚è½½åˆ°è¡Œç¨‹
æ–°å¢è½¦é˜Ÿç®¡ç†é¡µé¢ | åœ¨é€”åˆ—è¡¨ã€ç©ºé—²å¸æœº/è½¦è¾†åˆ—è¡¨ã€åœ°å›¾è½¨è¿¹ã€è¿‘30å¤©å†å²
å®Œå–„æ‰§è¡Œæµè½¬ | çŠ¶æ€æ¨è¿›ã€å¸æœºä¸Šä¼ PODï¼ˆPCç«¯ä»£ç†ä¸Šä¼ ï¼‰ã€é€šçŸ¥æœºåˆ¶
~~é¢„ç•™æ™ºèƒ½æŠ¥ä»·æ‰©å±•~~ | ~~å­—æ®µä¸APIé¢„ç•™ï¼Œæœ¬æœŸä¸å®ç°å®æ—¶è®¡ç®—~~ â†’ **âœ… å·²å®Œæ•´å®ç°**
æ–°å¢å·¦ä¾§å¯¼èˆªç³»ç»Ÿ | ç»Ÿä¸€é¡µé¢å¸ƒå±€ï¼Œæ”¯æŒæ”¶çª„/å±•å¼€åŠŸèƒ½
å®Œå–„åç«¯APIæ”¯æŒ | å®ç°å®Œæ•´çš„æ•°æ®åº“Schemaå’ŒAPIæ¥å£

---

## 1. äº§å“æ¦‚è¿°

### 1.1 äº§å“æ„¿æ™¯
æ‰“é€ ä¸€ä¸ªä»¥è§„åˆ™å¼•æ“ä¸ºæ ¸å¿ƒã€å¯é€æ­¥å¢é‡æ¼”è¿›çš„ç‰©æµè¿è¥ç®¡ç† SaaS å¹³å°ã€‚å½“å‰é˜¶æ®µèšç„¦â€œè¿å•å…¨æµç¨‹ + è°ƒåº¦åˆ†é… + è´¢åŠ¡è‡ªåŠ¨ç”Ÿæˆâ€ï¼›åç»­è¡¥å……â€œæ™ºèƒ½æŠ¥ä»·/åŠ¨æ€è®¡è´¹â€â€œå¸æœºè–ªé…¬æ™ºèƒ½è®¡ç®—â€â€œå¤šæ¸ é“è®¢å•æ¥å…¥â€ã€‚

### 1.2 ç›®æ ‡ç”¨æˆ·
- **ç‰©æµå…¬å¸ç®¡ç†å‘˜**ï¼šé…ç½®è§„åˆ™ã€æŸ¥çœ‹è¿è¥ä¸è´¢åŠ¡æ±‡æ€»ã€æƒé™ç®¡ç†  
- **è¿è¥/è°ƒåº¦äººå‘˜**ï¼šå½•å•ã€è°ƒåº¦å¸æœºã€è·Ÿè¸ªè¿å•çŠ¶æ€ã€å¤„ç†å¼‚å¸¸  
- **è´¢åŠ¡äººå‘˜**ï¼šå®¡æ ¸åº”æ”¶åº”ä»˜ã€å¯¼å‡ºå¯¹è´¦ã€ç™»è®°æ”¶ä»˜æ¬¾  
- **å¸æœº**ï¼šç§»åŠ¨ç«¯æ¥å•ã€çŠ¶æ€å›ä¼   
- **ï¼ˆæœªæ¥ï¼‰å®¢æˆ·è‡ªåŠ©ç«¯**ï¼šåœ¨çº¿åˆ›å»ºè¿å•/æŸ¥çœ‹è¿›åº¦  

---

## 2. åŠŸèƒ½éœ€æ±‚

### 2.1 è¿å•å…¨ç”Ÿå‘½å‘¨æœŸç®¡ç†ï¼ˆæ›´æ–°åï¼‰

**æ ¸å¿ƒç›®æ ‡**ï¼šè§£å†³â€œåˆ›å»ºå³å·²ç¡®è®¤â€çš„ä¸šåŠ¡æ¨¡å¼ä¸‹çš„é«˜æ•ˆè°ƒåº¦ä¸å¯è¿½è¸ªæ‰§è¡Œï¼›ä¿ç•™æœªæ¥è®¡è´¹æ‰©å±•ç©ºé—´ã€‚

#### 2.1.1 çŠ¶æ€æµï¼ˆç²¾ç®€ï¼‰
çŠ¶æ€ | è¯´æ˜ | è¿›å…¥æ¡ä»¶ | é€€å‡ºæ¡ä»¶
-----|------|----------|---------
created | è¿å•å·²åˆ›å»º = å·²ç¡®è®¤ | æ‰‹å·¥å½•å…¥ / API / å¯¼å…¥ | åˆ†é…å¸æœº / å–æ¶ˆ / å¼‚å¸¸
unassigned | ï¼ˆå¯é€‰åˆ«åï¼šready_for_dispatchï¼‰æœªåˆ†é…å¸æœºï¼ˆä¸ created å¯åˆå¹¶ï¼‰ | createdï¼ˆé»˜è®¤å³ unassignedï¼‰ | åˆ†é…å¸æœº
assigned | å·²æŒ‡æ´¾å¸æœº | é€‰æ‹©å¸æœº | å¸æœºå–è´§ / å–æ¶ˆ / å¼‚å¸¸
picked_up | å·²å–è´§ | å¸æœºç¡®è®¤å–è´§ | è¿è¾“ä¸­ / å¼‚å¸¸
in_transit | è¿è¾“é€”ä¸­ | å–è´§å®Œæˆ | å·²é€è¾¾ / å¼‚å¸¸
delivered | å·²é€è¾¾ï¼Œå¾…ç»“ç®— | å¸æœºå›ä¼  | å®Œæˆï¼ˆç»“ç®—ï¼‰ã€å¼‚å¸¸
completed | å®Œæˆé—­ç¯ï¼Œå·²ç”Ÿæˆè´¢åŠ¡ | å½•å…¥ finalCostï¼ˆæˆ–è€…ç¡®è®¤å·²æœ‰ï¼‰ | ç»ˆæ€
canceled | ç»ˆæ­¢ | ä»»ä¸€éç»ˆæ€æ‰‹åŠ¨å–æ¶ˆ | ç»ˆæ€
exception | å¼‚å¸¸ä¸­æ–­ | ä»»ä¸€éç»ˆæ€çŠ¶æ€æ ‡è®°å¼‚å¸¸ | å¯èƒ½æ¢å¤æˆ–å–æ¶ˆ

è¯´æ˜ï¼š
- created ä¸ unassigned å¯é€»è¾‘åˆä¸€ï¼ˆç³»ç»Ÿå†…éƒ¨å¯ç”¨ä¸€ä¸ªçŠ¶æ€ createdï¼Œç•Œé¢ä»¥â€œæœªåˆ†é…â€ç­›é€‰ï¼‰ã€‚è‹¥æœªæ¥å¼•å…¥â€œé¢„åˆ›å»ºè‰ç¨¿â€æ‰å†åŠ  draftã€‚
- ä¸å†æœ‰ quoted / confirmedï¼›æŠ¥ä»·é€»è¾‘å»¶åã€‚

#### 2.1.2 æ“ä½œä¸çº¦æŸ
æ“ä½œ | å‰ç½®çŠ¶æ€ | åç½®çŠ¶æ€ | æ ¸å¿ƒæ ¡éªŒ
-----|----------|----------|---------
åˆ›å»ºè¿å• | - | created | å­—æ®µå®Œæ•´æ ¡éªŒï¼ˆå‘è´§/æ”¶è´§/åŒ…è£¹è‡³å°‘ä¸€ä»¶ï¼‰
åˆ†é…å¸æœº | created/unassigned | assigned | å¸æœºå¯ç”¨çŠ¶æ€ã€æœªå†²çª
å–è´§ç¡®è®¤ | assigned | picked_up | æ—¶é—´æˆ³è‡ªåŠ¨ç”Ÿæˆ
è¿è¾“å¼€å§‹ï¼ˆå¯åˆå¹¶å–è´§ï¼‰ | picked_up | in_transit | -
é€è¾¾ç¡®è®¤ | in_transit | delivered | å¯è®°å½•ç…§ç‰‡/ç­¾æ”¶ç ï¼ˆæœªæ¥ï¼‰
ç»“ç®—å®Œæˆ | delivered | completed | finalCost å­˜åœ¨ï¼›å¹‚ç­‰æ£€æŸ¥
æ ‡è®°å¼‚å¸¸ | ä»»æ„éç»ˆæ€ | exception | å¼‚å¸¸ç±»å‹ä¸å¤‡æ³¨
å¼‚å¸¸æ¢å¤ | exception | æ¢å¤å‰ä¸€æ­£å¸¸çŠ¶æ€ / canceled | æ¡ˆä¾‹ï¼šå»¶è¿Ÿæ¢å¤ç»§ç»­ï¼›è´§æŸ â†’ å–æ¶ˆ
å–æ¶ˆè¿å• | created/unassigned/assigned | canceled | è‹¥å·² assigned éœ€é‡Šæ”¾å¸æœº

#### 2.1.3 ä¸šåŠ¡å­—æ®µï¼ˆæ‰©å±•ç‰ˆï¼‰â€”â€”åˆ›å»ºæ—¶å¯å½•å…¥

åˆ†ç»„ | å­—æ®µç¤ºä¾‹ | è¯´æ˜
-----|---------|-----
è®¢å•å…ƒä¿¡æ¯ | externalOrderNo, salesChannel, sourceType(manual/api/import), tags[], sellerNotes | æ”¯æŒç¬¬ä¸‰æ–¹æ¸ é“å…³è”
å‘è´§æ–¹(Ship From) | shipperName, shipperCompany, shipperContactName, shipperPhone, shipperEmail, shipperAddress{country,province,state,city,postalCode,addressLine1,addressLine2,isResidential} | æ”¯æŒåœ°å€ç°¿å¼•ç”¨ addressBookId
æ”¶è´§æ–¹(Ship To) | receiverName, receiverCompany, receiverContactName, receiverPhone, receiverEmail, receiverAddress{... åŒä¸Š} | isResidential å½±å“åç»­è®¡è´¹ï¼ˆé¢„ç•™ï¼‰
åŒ…è£¹åˆ—è¡¨ packages[] | packageId, boxName, length,width,height, dimensionUnit(cm), weight, weightUnit(kg), declaredValue, currency, remark | å¤šåŒ…è£¹æ”¯æŒ
å•†å“æ˜ç»† items[] | itemId, sku, description, hsCode, quantity, unitWeight, unitPrice, currency, originCountry | æ”¯æŒæŠ¥å…³
è´¹ç”¨é¢„ç•™å­—æ®µ | estimatedCost (nullable), pricingComponents[], pricingRuleTrace[] | æœ¬æœŸä¸è®¡ç®—ï¼Œä»…å­˜ç©ºç»“æ„
å¸æœºè°ƒåº¦ | driverId(åå¡«), assignedBy, assignedAt | åˆ†é…åå†™å…¥
è´§ç‰©å±æ€§ | cargoType(æ™®è´§/æ•æ„Ÿ), requiresColdChain(bool), fragile(bool), insured(bool), insuranceAmount | insuranceAmount ç›®å‰ä¸è®¡ç®—ä¿è´¹
å®‰å…¨åˆè§„ | dangerousGoodsCode(å¯é€‰), needSignature(bool), deliveryNote | é¢„ç•™æ‰©å±•
è¿½è¸ª | timeline[], currentStatus, statusUpdatedAt | ç³»ç»Ÿç»´æŠ¤
è´¢åŠ¡ | finalCostï¼ˆå®Œæˆæ—¶ï¼‰, costCurrency, adjustmentReason | å·®å¼‚è®°å½•
å®¡è®¡ | createdAt, createdBy, updatedAt, updatedBy, version | ä¹è§‚é”

#### 2.1.4 æ—¶é—´çº¿ (timeline) äº‹ä»¶ç±»å‹
- CREATED / DRIVER_ASSIGNED / PICKED_UP / IN_TRANSIT / DELIVERED / COMPLETED / CANCELED / EXCEPTION_SET / EXCEPTION_RESOLVED  
äº‹ä»¶ç»“æ„ï¼ševentId, shipmentId, eventType, fromStatus, toStatus, actorType(system/user/driver), actorId, timestamp, extra(JSON)

#### 2.1.5 æ•°æ®éªŒè¯åŸåˆ™ï¼ˆç¤ºä¾‹ï¼‰
å­—æ®µ | è§„åˆ™
-----|-----
weight | decimal(10,3) > 0
dimensions | æ¯è¾¹ > 0 ä¸” é•¿å®½é«˜åˆè§„ï¼ˆä¸Šé™é…ç½®ï¼‰
declaredValue / unitPrice | decimal(12,2) >= 0
currency | ISO 4217ï¼ˆé»˜è®¤ CNYï¼‰
phone | E.164 è§„èŒƒæˆ–æœ¬åœ°æ ‡å‡†ï¼›æ—¥å¿—è„±æ•
hsCode | é•¿åº¦ 4~10ï¼ˆæ ¼å¼æ­£åˆ™ï¼‰
tags | æ¯ä¸ªé•¿åº¦ <= 32ï¼›æœ€å¤š 10 ä¸ª

### 2.2 æ™ºèƒ½è®¡è´¹è§„åˆ™å¼•æ“ï¼ˆâœ… å·²å®Œæ•´å®ç°ï¼‰

**æ ¸å¿ƒåŠŸèƒ½**ï¼šæ”¯æŒå‘å¯¼å¼è§„åˆ™åˆ›å»ºã€æ¨¡æ¿ç®¡ç†ã€å®æ—¶è®¡ç®—å’Œé¢„è§ˆçš„å®Œæ•´è®¡è´¹è§„åˆ™å¼•æ“ã€‚

#### 2.2.1 åŠŸèƒ½æ¨¡å—
- **è§„åˆ™å‘å¯¼**ï¼š6æ­¥å‘å¯¼å¼ç•Œé¢ï¼Œå¼•å¯¼ç”¨æˆ·åˆ›å»ºå¤æ‚çš„è®¡è´¹è§„åˆ™
- **æ¨¡æ¿ç®¡ç†**ï¼šé¢„å®šä¹‰è®¡è´¹æ¨¡æ¿ï¼Œæ”¯æŒå¿«é€Ÿåº”ç”¨å’Œè‡ªå®šä¹‰ä¿®æ”¹
- **å®æ—¶è®¡ç®—å™¨**ï¼šåŸºäºè¿å•ä¿¡æ¯å®æ—¶è®¡ç®—è´¹ç”¨ï¼Œæ”¯æŒå¤šè§„åˆ™ç»„åˆ
- **è®¡è´¹é¦–é¡µ**ï¼šç»Ÿä¸€å…¥å£ï¼Œå±•ç¤ºè®¡è´¹ç»Ÿè®¡å’Œå¿«æ·æ“ä½œ

#### 2.2.2 è§„åˆ™ç±»å‹ï¼ˆå·²å®ç°ï¼‰
- **pricing**ï¼šæŒ‰é‡é‡/ä½“ç§¯/è·ç¦»/çº¿è·¯/æ—¶é—´æ®µ/å®¢æˆ·ç­‰çº§ç”Ÿæˆç»„ä»¶ä»·æ ¼
- **surcharge**ï¼šèŠ‚å‡æ—¥/åè¿œåœ°åŒº/å±é™©å“ç­‰é™„åŠ è´¹ç”¨
- **discount**ï¼šå®¢æˆ·ç­‰çº§ã€æ‰¹é‡ç­‰æŠ˜æ‰£è§„åˆ™
- **tax**ï¼šç¨è´¹è®¡ç®—è§„åˆ™

#### 2.2.3 APIæ¥å£ï¼ˆå·²å®ç°ï¼‰
- `GET /api/pricing/templates` - è·å–è®¡è´¹æ¨¡æ¿åˆ—è¡¨
- `POST /api/pricing/templates` - åˆ›å»ºè®¡è´¹æ¨¡æ¿
- `PUT /api/pricing/templates/:id` - æ›´æ–°è®¡è´¹æ¨¡æ¿
- `DELETE /api/pricing/templates/:id` - åˆ é™¤è®¡è´¹æ¨¡æ¿
- `POST /api/pricing/calculate` - å®æ—¶è®¡ç®—è´¹ç”¨
- `POST /api/pricing/preview` - è´¹ç”¨é¢„è§ˆï¼ˆæ›¿æ¢åŸé¢„ç•™æ¥å£ï¼‰
- `POST /api/pricing/test` - è§„åˆ™æµ‹è¯•å’ŒéªŒè¯

#### 2.2.4 æ•°æ®å­—æ®µï¼ˆå·²å®ç°ï¼‰
å­—æ®µ | ç±»å‹ | æè¿°
-----|------|-----
estimatedCost | decimal(12,2) | é¢„ä¼°æ€»ä»·ï¼ˆå®æ—¶è®¡ç®—ï¼‰
pricingComponents[] | JSON æ•°ç»„ | æ¯æ¡ï¼š{code,label,calcType,amount,sourceRuleId}
pricingRuleTrace[] | JSON æ•°ç»„ | {ruleId, version, appliedActions[], priority}
pricingTemplateId | string | å…³è”çš„è®¡è´¹æ¨¡æ¿ID
calculationHistory[] | JSON æ•°ç»„ | å†å²è®¡ç®—è®°å½•ï¼Œæ”¯æŒå®¡è®¡

### 2.3 è´¢åŠ¡è‡ªåŠ¨ç”Ÿæˆ

è§¦å‘ç‚¹ï¼šè¿å•çŠ¶æ€ â†’ completed  
- è‡ªåŠ¨ç”Ÿæˆåº”æ”¶(receivable)è®°å½•ï¼šamount = finalCostï¼ˆè‹¥ç¼ºå¤± â†’ é˜»æ–­å®Œæˆï¼‰  
- è‡ªåŠ¨ç”Ÿæˆåº”ä»˜(payable)è®°å½•ï¼ˆæœ¬æœŸå¯è®¾å®šç®€å•ç­–ç•¥ï¼šå¸æœºææˆæ¯”ä¾‹ä¸ºç§Ÿæˆ·é…ç½®çš„å…¨å±€å¸¸é‡ï¼Œå¦‚ driverCommissionRateï¼›è‹¥æ—  â†’ è®°å½• 0ï¼‰  
- å¹‚ç­‰ï¼šå”¯ä¸€çº¦æŸ (shipmentId, type)  
- ä¿å­˜ç»„ä»¶ breakdownï¼ˆé¢„ç•™ä¸ pricingComponents åŒºåˆ†ï¼šfinalCostComponents[]ï¼‰  

### 2.4 å¯¼å…¥ä¸æ‰¹é‡åˆ›å»ºï¼ˆé¢„ç•™ï¼‰

- æ”¯æŒ CSV æ¨¡æ¿ï¼šå¿…å¡«åˆ—ï¼ˆreceiverName, receiverPhone, shipToCity, shipToAddressLine1, weight, length,width,height æˆ– volumeï¼‰  
- å¯¼å…¥ä»»åŠ¡å¼‚æ­¥å¤„ç†ï¼Œæä¾›ä»»åŠ¡ ID æŸ¥è¯¢è¿›åº¦  
- é”™è¯¯è¡Œç”Ÿæˆé”™è¯¯æŠ¥å‘Šï¼ˆå¯ä¸‹è½½ï¼‰  

### 2.5 å¼‚å¸¸å¤„ç†

å¼‚å¸¸ç±»å‹ï¼ˆåˆç¨¿ï¼‰ï¼šDELAY, DAMAGE, LOST, PARTIAL_LOSS, ADDRESS_ISSUE, WEATHER, OTHER  
å­—æ®µï¼šexceptionType, exceptionDescription, raisedAt, resolvedAt, resolutionNote  
è§„åˆ™ï¼š
- exception çŠ¶æ€ä¸ç”Ÿæˆè´¢åŠ¡  
- æ¢å¤æ—¶å¿…é¡»å†™ resolutionNote  
- å¯é…ç½®â€œè¶…æ—¶æœªå–è´§è‡ªåŠ¨æ ‡è®°å»¶è¿Ÿâ€å®šæ—¶ä»»åŠ¡ï¼ˆæœªæ¥ï¼‰  

--- 

## 3. éåŠŸèƒ½éœ€æ±‚ï¼ˆæ²¿ç”¨ + è¡¥å……ï¼‰

ç±»åˆ« | éœ€æ±‚æè¿°
-----|--------
æ€§èƒ½ | æ ¸å¿ƒçŠ¶æ€å˜æ›´ / åˆ—è¡¨æŸ¥è¯¢å¹³å‡å“åº” < 500msï¼›åˆ›å»ºæ‰¹é‡å¯¼å…¥ä»»åŠ¡ < 2s è¿”å›ä»»åŠ¡ID
å®‰å…¨ | å…¨é‡å¤šç§Ÿæˆ·éš”ç¦»ï¼ˆWHERE tenant_id= ?ï¼‰ï¼›èµ„æºçº§æƒé™
å¯ç”¨æ€§ | æ ¸å¿ƒæœåŠ¡å¯ç”¨æ€§ 99.9%
æ•°æ®å‡†ç¡®æ€§ | è´¢åŠ¡ç”Ÿæˆå¹‚ç­‰ï¼Œé‡‘é¢ç´¯è®¡è¯¯å·® < 0.01ï¼›æ¯ç¬”ä¿®æ”¹å®¡è®¡
å¯è¿½æº¯ | timeline ä¸ ruleTraceï¼ˆè™½æš‚ç©ºï¼‰ä¸å¯ç¼–è¾‘ä»…è¿½åŠ 
å¯æ‰©å±• | è§„åˆ™æ‰§è¡Œæ¡†æ¶æ¨¡å—åŒ–ï¼ˆfutureï¼‰ï¼›åŒ…è£¹/å•†å“ç»“æ„æ”¯æŒå¤šæ¡
ç›‘æ§ | æŒ‡æ ‡ï¼šçŠ¶æ€è½¬æ¢è€—æ—¶ã€å¼‚å¸¸ç‡ã€æœªåˆ†é…è¶…æ—¶æ•°ã€ç”Ÿæˆè´¢åŠ¡å»¶è¿Ÿ
å›½é™…åŒ–é¢„ç•™ | åœ°å€ç»“æ„ country + çœ/å· + åŸå¸‚ + é‚®ç¼–ï¼›currency å­—æ®µæ ‡å‡†åŒ–
åˆè§„ | ä¸ªäººä¿¡æ¯ï¼ˆç”µè¯/é‚®ç®±ï¼‰è®¿é—®éœ€æƒé™ï¼›æ—¥å¿—è„±æ•

---

## 4. æ ¸å¿ƒæ•°æ®æ¨¡å‹ï¼ˆé«˜å±‚æ‹†è§£ï¼‰

å®ä½“ | è¯´æ˜ | å…³é”®å­—æ®µï¼ˆéƒ¨åˆ†ï¼‰
-----|------|-----------
shipment | è¿å•ä¸»è¡¨ | id, tenantId, shipmentNo, externalOrderNo, salesChannel, status, driverId, estimatedCost, finalCost, costCurrency, createdAt
shipment_party | å‘/æ”¶ä»¶å®ä½“ï¼ˆå¯é€‰ï¼‰ | id, shipmentId, role(SHIPPER/RECEIVER), name, company, contactName, phone, email, country, province, city, postalCode, addressLine1, addressLine2, isResidential
shipment_package | åŒ…è£¹ | id, shipmentId, boxName, length,width,height, dimensionUnit, weight, weightUnit, declaredValue, currency, remark
shipment_item | å•†å“æ˜ç»† | id, shipmentId, packageId(nullå¯), sku, description, hsCode, quantity, unitWeight, unitPrice, currency, originCountry
shipment_timeline | äº‹ä»¶ | id, shipmentId, eventType, fromStatus, toStatus, actorType, actorId, timestamp, extra
rule (é¢„ç•™) | è§„åˆ™ | id, type, tenantId, priority, conditions(JSON), actions(JSON), enabled, version
shipment_pricing_trace (é¢„ç•™) | è§„åˆ™è¿½è¸ª | id, shipmentId, ruleId, ruleVersion, actionSummary, componentDelta(JSON)
financial_record | è´¢åŠ¡è®°å½• | id, shipmentId, type(receivable/payable), partyId, amount, currency, status, generatedAt, paidAt
financial_component | é‡‘é¢ç»„ä»¶ | id, financialRecordId, code, label, amount, sequence
audit_log | å®¡è®¡ | id, entityType, entityId, field, oldValue, newValue, actorId, actorType, timestamp
driver (å‚è€ƒ) | å¸æœº | id, tenantId, name, phone, status, capacity (é¢„ç•™), commissionRate(optional)
tenant_setting | ç§Ÿæˆ·é…ç½® | id, tenantId, key, value(JSON)ï¼ˆå¦‚é»˜è®¤å¸æœºææˆï¼‰

è¯´æ˜ï¼š
- estimatedCost ä¸ pricingComponents æš‚ä¸å†™å…¥ financial_componentï¼ˆä»… final ä½¿ç”¨ï¼‰
- pricingComponents å¯åæœŸå•ç‹¬æ‹†è¡¨ï¼›æš‚å¯å­˜åœ¨ shipment JSON å­—æ®µ pricingComponents (JSON)

---

## 5. çŠ¶æ€æœºï¼ˆ2.1 ç‰ˆï¼‰

çŠ¶æ€é›†åˆï¼šcreated â†’ assigned â†’ picked_up â†’ in_transit â†’ delivered â†’ completed  
åˆ†æ”¯ï¼šexception / canceledï¼ˆç»ˆæ€ä¹‹ä¸€ï¼‰  

åˆæ³•è½¬æ¢ï¼š
- created â†’ assigned / canceled / exception
- assigned â†’ picked_up / canceled / exception
- picked_up â†’ in_transit / exception
- in_transit â†’ delivered / exception
- delivered â†’ completed / exception
- exception â†’ ï¼ˆæ¢å¤åˆ° previousNormalStatusï¼‰ / canceled
- ä»»æ„éç»ˆæ€ â†’ canceled

æ ¡éªŒï¼š
- å®Œæˆï¼ˆcompletedï¼‰å‰ï¼šfinalCost å¿…å¡«
- å–æ¶ˆæ—¶ï¼šè‹¥å·² assigned åˆ™å†™å…¥ driverReleasedAt
- timeline å¼ºåˆ¶è¿½åŠ ï¼›ä¸å…è®¸åˆ é™¤/è¦†ç›–

---

## 6. APIï¼ˆé€‰æ‘˜ & åè®®é¢„ç•™ï¼‰

### 6.1 åˆ›å»ºè¿å•
POST /api/shipments  
Bodyï¼ˆç®€åŒ–ç¤ºä¾‹ï¼‰ï¼š
```
{
  "externalOrderNo": "EC-20250923-001",
  "salesChannel": "DIRECT",
  "tags": ["B2C"],
  "shipper": {...},
  "receiver": {...},
  "packages": [
    { "boxName":"BOX-A","length":30,"width":20,"height":15,"dimensionUnit":"cm","weight":3.25,"weightUnit":"kg","declaredValue":120,"currency":"CNY" }
  ],
  "items": [
    { "sku":"SKU-1","description":"brown leather handbag","quantity":2,"unitWeight":1.2,"unitPrice":60,"currency":"CNY" }
  ],
  "cargoType": "GENERAL",
  "fragile": true,
  "insured": false
}
```
Response: 201 + shipment åŸºæœ¬ä¿¡æ¯ï¼ˆstatus=createdï¼‰

### 6.2 åˆ†é…å¸æœº
POST /api/shipments/{id}/assign-driver  
Body: { "driverId": "...", "idempotencyKey": "..." }

### 6.3 çŠ¶æ€æ›´æ–°ï¼ˆé€šç”¨ï¼‰
PATCH /api/shipments/{id}/status  
Body: { "targetStatus":"picked_up", "idempotencyKey":"...", "reason":null }

è¿”å›ï¼štimeline äº‹ä»¶ IDã€‚

### 6.4 å®Œæˆè¿å•
POST /api/shipments/{id}/complete  
Body: { "finalCost": 560.00, "currency":"CNY", "components":[ {"code":"BASE","amount":400}, {"code":"FUEL","amount":80}, {"code":"DISTANCE","amount":100}, {"code":"ROUND","amount":-20} ] }  
æ ¡éªŒï¼šcomponents é‡‘é¢æ±‚å’Œ == finalCost

### 6.5 æ™ºèƒ½è®¡è´¹é¢„è§ˆï¼ˆâœ… å·²å®ç°ï¼‰
POST /api/pricing/preview  
Body: { "shipmentData": {...}, "templateId": "..." }  
Response: 200 + è¯¦ç»†è´¹ç”¨åˆ†è§£å’Œè®¡ç®—è¿‡ç¨‹

---

## 7. æƒé™ï¼ˆç®€åŒ–è‰æ¡ˆï¼‰
è§’è‰² | èƒ½åŠ›
-----|-----
ADMIN | å…¨éƒ¨ + ç§Ÿæˆ·è®¾ç½® + è§„åˆ™ç®¡ç†ï¼ˆæœªæ¥ï¼‰
OPERATOR | åˆ›å»º/æŸ¥çœ‹/åˆ†é…/çŠ¶æ€æ›´æ–°(éè´¢åŠ¡)/å¼‚å¸¸å¤„ç†
DISPATCHERï¼ˆå¯ä¸ OPERATOR åˆå¹¶ï¼‰ | åˆ†é…å¸æœºã€æŸ¥çœ‹å¸æœºè´Ÿè½½
FINANCE | æŸ¥çœ‹è¿å• + æŸ¥çœ‹/ä¿®æ”¹è´¢åŠ¡è®°å½•æ”¯ä»˜çŠ¶æ€
DRIVER | ä»…è®¿é—®è‡ªå·±è¢«åˆ†é…è¿å•ã€æ›´æ–°è¿è¾“ç›¸å…³çŠ¶æ€
AUDITOR | åªè¯»æ‰€æœ‰æ•°æ®ï¼ˆä¸å«æ•æ„Ÿè”ç³»æ–¹å¼è„±æ•å‰ç‰ˆæœ¬ï¼‰

èµ„æºçº§é™åˆ¶ï¼šdriverId ä»…å¯æ“ä½œå±äºè‡ªå·±çš„è¿å•çŠ¶æ€ï¼ˆpicked_up/in_transit/deliveredï¼‰ã€‚

---

## 8. è´¢åŠ¡å¤„ç†ç»†åŒ–ï¼ˆä¸å˜ + ç»“åˆæ–°å­—æ®µï¼‰

æµç¨‹ï¼š
1. delivered â†’ è¿è¥æ ¸å¯¹ â†’ finalCost è¾“å…¥  
2. complete()ï¼šå†™ financial_record (receivable + payable)  
3. payable.amount = finalCost * commissionRate(ç§Ÿæˆ·çº§æˆ–å¸æœºçº§)ï¼ˆæœ¬æœŸç®€å•ï¼‰  
4. financial_component å­˜ finalCost åˆ†è§£  
5. çŠ¶æ€ï¼špending â†’ paidï¼ˆæ‰‹å·¥ç™»è®°ï¼‰  

çº¦æŸï¼š
- å¹‚ç­‰ï¼šunique(shipmentId, type)
- finalCost ä¸å¯ä¸ºè´Ÿ
- ä¿®æ”¹ finalCostï¼ˆè‹¥å…è®¸ï¼‰éœ€è¦ç”Ÿæˆé€†å‘è°ƒæ•´ï¼ˆå»ºè®®ï¼šå®Œæˆåä¸å…è®¸ç›´æ¥æ”¹ï¼Œå¿…é¡»ç”¨ credit/debit component è¿½åŠ ï¼‰

---

## 9. å¼‚å¸¸ä¸å–æ¶ˆç­–ç•¥

åœºæ™¯ | ç»“æœ | å¤‡æ³¨
-----|------|-----
å·² assigned å–æ¶ˆ | driverReleasedAt å¡«å†™ | åç»­å¯ç»Ÿè®¡å¸æœºè¢«å ç”¨æ—¶é•¿
å¼‚å¸¸æ¢å¤ | æ¢å¤åˆ°ä¸Šä¸€é€»è¾‘çŠ¶æ€ | timeline è®°å½• EXCEPTION_RESOLVED
å·²å®Œæˆä¸å…è®¸å¼‚å¸¸ | - | éœ€é‡æ–°å¼€è¡¥å•ï¼ˆä¸šåŠ¡æ²»ç†ï¼‰
ä¸¢å¤±(Lost) | èµ°ç†èµ”ï¼ˆæœªæ¥ï¼‰ | ååŒä¿é™©æ¨¡å—

---

## 10. ç›‘æ§ä¸æŒ‡æ ‡ï¼ˆä¸ 2.0 è¡”æ¥ï¼Œä¿æŒé¢„ç•™å®šä»·æŒ‡æ ‡ï¼‰

æŒ‡æ ‡ | å®šä¹‰ | è¯´æ˜
-----|------|-----
dispatch_wait_time | createdâ†’assigned è€—æ—¶ P50/P95 | è°ƒåº¦æ•ˆç‡
pickup_delay_rate | assigned åè¶…è¿‡é˜ˆå€¼æœªå–è´§æ¯”ç‡ | è¿è¥é¢„è­¦
transit_time | picked_upâ†’delivered | è¿è¾“æ•ˆç‡
completion_latency | deliveredâ†’completed | è´¢åŠ¡åŠæ—¶æ€§
exception_rate | å¼‚å¸¸è¿å•æ•° / æ€»è¿å• | æœåŠ¡è´¨é‡
cost_adjustment_ratio (future) | | finalCost ä¸ estimatedCost å·®å¼‚ï¼ˆå…ˆä¸ºç©ºï¼‰
financial_gen_delay | completedâ†’financial_record å†™å…¥ | éœ€ < 5s

---

## 11. å®¡è®¡ä¸å¹‚ç­‰

æ“ä½œ | å¹‚ç­‰æ–¹å¼ | è®°å½•
-----|----------|-----
åˆ›å»ºè¿å• | è‡ªç„¶é”® externalOrderNo + tenantId å¯é€‰ï¼›æˆ– idempotencyKey | audit_log
çŠ¶æ€æ›´æ–° | idempotencyKey | timeline
åˆ†é…å¸æœº | idempotencyKey | timeline + audit_log
å®Œæˆç»“ç®— | (shipmentId, operationType) å”¯ä¸€ | timeline + financial_record
ç”Ÿæˆè´¢åŠ¡ | æ•°æ®åº“å”¯ä¸€çº¦æŸ | audit_log
å–æ¶ˆ/å¼‚å¸¸ | event å”¯ä¸€ id | timeline

---

## 12. åç»­è¿­ä»£è·¯çº¿ï¼ˆä¸ 2.0 å»ºè®®å¯¹é½ï¼Œç»“åˆå˜æ›´ï¼‰

Sprint | èŒƒå›´ | éªŒæ”¶
-------|------|-----
S1 | è¿å•åˆ›å»º + çŠ¶æ€æœº(createdâ†’assignedâ†’picked_upâ†’in_transitâ†’deliveredâ†’completed) + ç®€å•è´¢åŠ¡ | å®Œæˆé—­ç¯æ‰‹å·¥ finalCost
S2 | å¯¼å…¥/æ‰¹é‡ + å¼‚å¸¸æµç¨‹ + å®¡è®¡æ—¥å¿— | å¯æŸ¥è¯¢å¼‚å¸¸ & æ¢å¤
S3 | å¸æœºç«¯åŸºç¡€æ¥å£ + å¸æœºå·¥ä½œé‡ç»Ÿè®¡ | å¸æœºèƒ½æ›´æ–°çŠ¶æ€
S4 | åŸºç¡€åº”ä»˜ï¼ˆææˆç‡ï¼‰ + è´¢åŠ¡ç»„ä»¶æ‹†åˆ† | åº”æ”¶åº”ä»˜ä¸€è‡´æ€§
S5 | è§„åˆ™å¼•æ“å¼•å…¥ï¼ˆpricing MVPï¼Œåªåšé¢„ä¼°ï¼‰ | estimatedCost è®¡ç®—
S6 | payroll è§„åˆ™ & å¤æ‚å åŠ  | é©±åŠ¨å¯å˜ä½£é‡‘
S7 | æŒ‡æ ‡/ç›‘æ§ä»ªè¡¨æ¿ + ä¼˜åŒ–è°ƒåº¦ï¼ˆå¯ç”¨æ€§ï¼‰ | æŒ‡æ ‡å±•ç¤º
S8 | æ¸ é“æ¥å…¥(API/Webhook) | å¯å¤–éƒ¨ä¸‹å•

---

## 13. é£é™© & ç¼“è§£ï¼ˆç›¸å¯¹ 2.0 æ›´æ–°ï¼‰

é£é™© | å½±å“ | ç¼“è§£
-----|------|-----
æ— æŠ¥ä»·ä¸Šçº¿åè¡¥åŠ å½±å“å†å²å• | æ—§å•ç¼ºå°‘ estimatedCost | åˆ›å»ºæ—¶ä¸ºç©ºå¹¶è®°å½• nullï¼›åæœŸä¸å›å¡«
finalCost äººå·¥é”™è¯¯ | è´¢åŠ¡å·®é”™ | åŒè¾“å…¥æ ¡éªŒæˆ–å…è®¸äºŒæ¬¡å®¡æ ¸
å¤šåŒ…è£¹/å¤šå•†å“æ•°æ®è†¨èƒ€ | æŸ¥è¯¢æ€§èƒ½ | åˆ†é¡µ+èšåˆè§†å›¾ï¼ˆè®¡æ•°ä¸é‡é‡ç¼“å­˜ï¼‰
å¸æœºæ»¥ç”¨çŠ¶æ€æ›´æ–° | æ•°æ®å¤±çœŸ | æœåŠ¡ç«¯çŠ¶æ€åˆæ³•é“¾æ ¡éªŒ + é¢‘æ¬¡é™åˆ¶
æ‰¹é‡å¯¼å…¥é”™è¯¯é›†ä¸­ | è¿è¥æ•ˆç‡ | å¼‚æ­¥æ ¡éªŒ + é”™è¯¯æŠ¥å‘Šä¸‹è½½
è§„åˆ™å¼•å…¥åæ€§èƒ½ | æŸ¥è¯¢å»¶è¿Ÿ | é¢„ç¼–è¯‘ + ç¼“å­˜ + é™åˆ¶è§„åˆ™æ•°

---

## 14. é™„å½•ï¼šç¤ºä¾‹è¿å• JSONï¼ˆå½“å‰é˜¶æ®µï¼‰

```
{
  "id": "SHIP-20250923-001",
  "tenantId": "TEN-1",
  "shipmentNo": "TMS202509230001",
  "externalOrderNo": "EC-20250923-001",
  "salesChannel": "DIRECT",
  "status": "assigned",
  "tags": ["B2C"],
  "shipper": {
    "name": "Alice",
    "phone": "+14165550000",
    "address": {
      "country": "CA",
      "province": "Ontario",
      "city": "Toronto",
      "postalCode": "M5V1A1",
      "addressLine1": "228-8323 Kennedy Rd",
      "isResidential": false
    }
  },
  "receiver": {
    "name": "Bob",
    "phone": "+14165551111",
    "address": {
      "country": "CA",
      "province": "Ontario",
      "city": "Markham",
      "postalCode": "L3R5W7",
      "addressLine1": "88 Apple Ave",
      "isResidential": true
    }
  },
  "packages": [
    {
      "packageId": "PKG-1",
      "boxName": "BOX-A",
      "length": 30,
      "width": 20,
      "height": 15,
      "dimensionUnit": "cm",
      "weight": 3.25,
      "weightUnit": "kg",
      "declaredValue": 120.00,
      "currency": "CNY"
    }
  ],
  "items": [
    {
      "itemId": "ITEM-1",
      "sku": "SKU-1",
      "description": "brown leather handbag",
      "hsCode": "420221",
      "quantity": 2,
      "unitWeight": 1.2,
      "unitPrice": 60.00,
      "currency": "CNY"
    }
  ],
  "cargoType": "GENERAL",
  "fragile": true,
  "insured": false,
  "driverId": "DRIVER-7",
  "assignedAt": "2025-09-29 09:12:36T09:15:00Z",
  "estimatedCost": null,
  "pricingComponents": [],
  "pricingRuleTrace": [],
  "finalCost": null,
  "timeline": [
    { "eventType": "CREATED", "timestamp": "2025-09-29 09:12:36T09:00:00Z" },
    { "eventType": "DRIVER_ASSIGNED", "timestamp": "2025-09-29 09:12:36T09:15:00Z" }
  ],
  "createdAt": "2025-09-29 09:12:36T09:00:00Z",
  "updatedAt": "2025-09-29 09:12:36T09:15:00Z",
  "version": 3
}
```

---

## 15. å¾…è¿›ä¸€æ­¥è¡¥å……ï¼ˆåç»­ 2.2 å»ºè®®ï¼‰

- è¯¦ç»† DDLï¼ˆå­—æ®µç±»å‹/ç´¢å¼•ï¼‰
- è§„åˆ™ DSL Schemaï¼ˆJSON Schema å®šä¹‰ï¼‰
- é©±åŠ¨è°ƒåº¦ç­–ç•¥ï¼ˆæœªæ¥ï¼šå®¹é‡ / è·ç¦» / åœ°ç†è´Ÿè½½ï¼‰
- å¸æœºç§»åŠ¨ç«¯äº¤äº’ä¸æƒé™ç»†åŒ–
- å¼‚å¸¸åˆ†ç±»ä»£ç è¡¨
- API é”™è¯¯ç æ ‡å‡†

---

è‹¥éœ€æˆ‘ç»§ç»­è¾“å‡º DDL è‰æ¡ˆæˆ–è§„åˆ™ Schemaï¼Œè¯·å‘ŠçŸ¥ä¸‹ä¸€æ­¥éœ€æ±‚ã€‚  
ï¼ˆæœ¬æ–‡ä»¶å·²æ ¹æ®ä½ çš„ 3 ç‚¹æŒ‡ä»¤è¿›è¡Œç»“æ„åŒ–ä¿®æ”¹ä¸æ‰©å±•ã€‚ï¼‰

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 16. è§’è‰²ä¸æƒé™çŸ©é˜µè¡¨ï¼ˆç»†åŒ–ï¼‰

è§’è‰² | é¡µé¢è®¿é—® | æ¥å£æƒé™ | å¯¹è±¡çº§æƒé™ | å­—æ®µçº§æƒé™ | å®¡æ‰¹/å‘å¸ƒ | å¯¼å‡º | å¤‡æ³¨
-----|---------|---------|-----------|-----------|-----------|------|-----
ç³»ç»Ÿç®¡ç†å‘˜ | å…¨éƒ¨ | å…¨éƒ¨ | å…¨éƒ¨ | æŸ¥çœ‹è„±æ•å‰ | è§„åˆ™/ç§Ÿæˆ·è®¾ç½® | å…è®¸ | å¹³å°çº§
ç§Ÿæˆ·ç®¡ç†å‘˜ | å…¨éƒ¨ï¼ˆæœ¬ç§Ÿæˆ·ï¼‰ | æœ¬ç§Ÿæˆ·å…¨éƒ¨ | æœ¬ç§Ÿæˆ·å…¨éƒ¨ | å¯ç”³è¯·æ•æ„Ÿå­—æ®µæŸ¥çœ‹ | è§„åˆ™å‘å¸ƒï¼ˆæœ¬ç§Ÿæˆ·ï¼‰ | å…è®¸ | æœ€å°åŒ–æˆæƒ
è¿è¥/è°ƒåº¦ | è¿å•/å¸æœº/çœ‹æ¿ | è¿å•è¯»å†™ã€åˆ†é… | è¿å• R/Wã€å¸æœºåˆ†é… | è„±æ•ï¼ˆç”µè¯ä»…æœ«4ä½ï¼‰ | æ—  | å…è®¸ | ç¦æ­¢è´¢åŠ¡æ”¹åŠ¨
è´¢åŠ¡ | è¿å•/è´¢åŠ¡ | è´¢åŠ¡è®°å½•è¯»å†™ | è´¢åŠ¡ R/W | æŸ¥çœ‹ä»·æ ¼æ˜ç»† | è¿‡è´¦å®¡æ‰¹ | å…è®¸ | é‡‘é¢æ•æ„Ÿ
å®¢æœ | è¿å•æŸ¥çœ‹/æŸ¥è¯¢ | è¿å•åªè¯» | è¿å• R | è„±æ• | æ—  | å…è®¸ | æ— ç¼–è¾‘
å¸æœº | å¸æœºç§»åŠ¨ç«¯ | è‡ªå·±ç›¸å…³æ¥å£ | è‡ªå·±è¿å•çŠ¶æ€ R/W | æ— æ•æ„Ÿå­—æ®µ | æ—  | å¦ | ä»…è‡ªèº«
å®¡è®¡ | å®¡è®¡æŠ¥è¡¨/æ—¥å¿— | æŸ¥è¯¢æ¥å£ | å…¨éƒ¨åªè¯» | å¯æŸ¥çœ‹è„±æ•å‰ï¼ˆå—åˆè§„æ§åˆ¶ï¼‰ | æ—  | å¯å¯¼å‡º | å—ç•™å­˜ç­–ç•¥
åªè¯»è®¿å®¢ | åŸºæœ¬çœ‹æ¿ | æŸ¥è¯¢æ¥å£ | éƒ¨åˆ†å¯¹è±¡åªè¯» | å…¨éƒ¨è„±æ• | æ—  | å¦ | ç”¨äºæ¼”ç¤º/åŸ¹è®­

åŸåˆ™ï¼š
- æœ€å°æƒé™åŸåˆ™ï¼›æ•æ„Ÿå­—æ®µï¼ˆæ‰‹æœºå·ã€èº«ä»½è¯ã€é‡‘é¢æ˜ç»†ï¼‰é»˜è®¤è„±æ•æ˜¾ç¤ºï¼›æŒ‰éœ€å®¡æ‰¹å¼€é€šã€‚
- é«˜é£é™©æ“ä½œï¼ˆè§„åˆ™å‘å¸ƒã€æ‰¹é‡å¯¼å‡ºã€è´¢åŠ¡è¿‡è´¦ï¼‰éœ€è¦åŒäººå®¡æ‰¹ä¸å®¡è®¡ã€‚

å…³é”®å¯¹è±¡-æ“ä½œçŸ©é˜µï¼ˆæ‘˜å½•ï¼‰ï¼š
å¯¹è±¡/æ“ä½œ | åˆ›å»º | ç¼–è¾‘ | æŸ¥çœ‹ | åˆ é™¤ | å¯¼å‡º | å®¡æ‰¹
----------|------|------|------|------|------|------
è¿å• | OPERATOR | OPERATOR | ALL | ADMIN/TENANT_ADMIN | OPERATOR/FINANCE/AUDITOR | -
è§„åˆ™(pricing/payroll) | ADMIN/TENANT_ADMIN | ADMIN/TENANT_ADMIN | ALL | ADMIN/TENANT_ADMIN | ADMIN/TENANT_ADMIN | ADMIN/TENANT_ADMIN
è´¢åŠ¡è®°å½• | ç³»ç»Ÿç”Ÿæˆ | FINANCE(è°ƒæ•´) | FINANCE/AUDITOR/ADMIN | - | FINANCE/AUDITOR | FINANCE/ADMIN

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 17. è§„åˆ™å¼•æ“ DSL & æ¡ä»¶/åŠ¨ä½œç™½åå•

è¯­æ³•ï¼š
- å½¢å¼ï¼š`IF <expr> THEN <action>[, <action>...] [PRIORITY n] [LABEL "..."]`
- ç»„åˆï¼šAND/ORï¼Œæ‹¬å·ï¼Œæœ€å¤§åµŒå¥—æ·±åº¦ 3ï¼›å•è§„åˆ™æœ€å¤§é•¿åº¦ 2KBï¼›æ¯æ¬¡æ‰§è¡Œæœ€å¤šå‘½ä¸­ 20 æ¡ã€‚
- è¶…æ—¶ï¼šå•è¿å•è§„åˆ™è¯„ä¼°æ€»æ—¶é•¿ â‰¤ 100msï¼›æ¯æ¡ â‰¤ 10msã€‚

æ¡ä»¶å­—æ®µç™½åå•ï¼ˆç¤ºä¾‹ï¼ŒæŒ‰åŸŸåˆ†ç»„ï¼‰ï¼š
- è¿å•ï¼š`weight, volume, cargoType, pickup.city, delivery.city, distanceKm, createdAt`
- å®¢æˆ·ï¼š`customerId, customerTier`
- å¸æœºï¼š`driverId, driverLevel`ï¼ˆåªè¯»ï¼Œä¸å…è®¸ä½œä¸ºå‰¯ä½œç”¨æ¡ä»¶ä¿®æ”¹ï¼‰
- ç¯å¢ƒï¼š`tenantId, channel, weekday, timeOfDay`

æ“ä½œç¬¦ï¼š`=, !=, >, >=, <, <=, IN, NOT IN, STARTS_WITH, ENDS_WITH, CONTAINS`

å‡½æ•°ç™½åå•ï¼ˆçº¯å‡½æ•°ï¼‰ï¼š`round(v,d)`, `ceil(v)`, `floor(v)`, `min(a,b)`, `max(a,b)`, `rateLookup(table,key)`

åŠ¨ä½œç™½åå•ï¼š
- è®¡è´¹ï¼š`addFee(code, amount, currency)`, `applyDiscount(code, percent|amount)`, `setTax(percent)`, `setFinalPrice(amount)`
- è–ªé…¬ï¼š`setDriverCommission(percent|amount)`
- æ§åˆ¶ï¼š`stopProcessing()`
- ç¦æ­¢ï¼šæ•°æ®åº“å†™å…¥ã€å¤–éƒ¨ HTTP è°ƒç”¨ã€æ–‡ä»¶ç³»ç»Ÿæ“ä½œï¼›å¤–éƒ¨é€šçŸ¥éœ€é€šè¿‡å¼‚æ­¥é˜Ÿåˆ—ç”±åç«¯ç»Ÿä¸€ç½‘å…³è§¦å‘ã€‚

å®‰å…¨ä¸å®¡è®¡ï¼šè§„åˆ™ç‰ˆæœ¬åŒ–ï¼›è¾“å…¥/å‘½ä¸­è½¨è¿¹/è¾“å‡ºæ˜ç»†è„±æ•å­˜æ¡£â‰¥365å¤©ï¼›é€Ÿç‡é™åˆ¶ä¸ç§Ÿæˆ·çº§è§„åˆ™æ€»é‡é™é¢ã€‚

ç¤ºä¾‹ï¼š
```
IF pickup.city = "ä¸Šæµ·" AND weight > 1000 THEN addFee("HEAVY", round(weight*0.2,2), "CNY")
IF customerTier IN ("VIP","GOLD") THEN applyDiscount("TIER", 0.05)
```

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 18. è¿å•å­—æ®µå®Œæ•´è¡¨ï¼ˆç±»å‹/é•¿åº¦/éªŒè¯ï¼‰

å­—æ®µ | ç±»å‹/é•¿åº¦ | çº¦æŸ | éªŒè¯/è¯´æ˜
-----|-----------|------|-----------
shipmentNo | STRING(20) | PK, å”¯ä¸€, å¿…å¡« | è§„åˆ™ï¼šTMSYYYYMMDDNNNN
tenantId | STRING(36) | å¿…å¡« | å¤šç§Ÿæˆ·éš”ç¦»
externalOrderNo | STRING(50) | å¯ç©º | ç¬¬ä¸‰æ–¹è®¢å•å·
salesChannel | ENUM | é»˜è®¤ DIRECT | å—æ§å­—å…¸
status | ENUM | å¿…å¡« | created/assigned/...ï¼ˆè¯¦è§çŠ¶æ€æœºï¼‰
driverId | STRING(36) | å¯ç©º | åˆ†é…åå†™å…¥
shipper/receiver.name | STRING(50) | å¿…å¡« | éç©ºç™½
shipper/receiver.phone | STRING(20) | å¿…å¡« | E.164 æˆ–æœ¬åœ°æ ¼å¼
addresses.* | STRING(2..200) | å¿…å¡« | ISO å›½å®¶ + è¡Œæ”¿åŒº + è¯¦ç»†åœ°å€
packages[].length/width/height | DECIMAL(8,2) | >0 | å•ä½ cm
packages[].weight | DECIMAL(10,3) | >0 | å•ä½ kg
packages[].declaredValue | DECIMAL(12,2) | â‰¥0 | å¸ç§ currency
items[].sku | STRING(40) | å¯ç©º | -
items[].hsCode | STRING(4..10) | å¯ç©º | æ­£åˆ™æ ¡éªŒ
estimatedCost | DECIMAL(12,2) | å¯ç©º | é¢„ä¼°ä»·
finalCost | DECIMAL(12,2) | å®Œæˆå¿…å¡« | >=0
currency | STRING(3) | é»˜è®¤ CNY | ISO 4217
timeline | JSON | ä»…è¿½åŠ  | äº‹ä»¶è¿½è¸ª
audit fields | datetime/user | è‡ªåŠ¨ | createdAt/By, updatedAt/By
piiMasked | BOOLEAN | é»˜è®¤ true | å‰ç«¯å±•ç¤ºè„±æ•

ç´¢å¼•å»ºè®®ï¼š`UNIQUE(shipmentNo)`, `INDEX(tenantId,status,createdAt)`, è§†éœ€è¦ä¸ºåŸå¸‚å»ºç«‹å‰ç¼€ç´¢å¼•ã€‚

é”™è¯¯ç ï¼šWB_1001(æ‰‹æœºå·æ— æ•ˆ)ï¼ŒWB_1002(é‡é‡/ä½“ç§¯ä¸ºè´Ÿ)ï¼ŒWB_1003(å¸ç§ä¸æ”¯æŒ)ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 19. çŠ¶æ€æœºå›¾ + å¼‚å¸¸æ¢å¤ç­–ç•¥ï¼ˆç»†åŒ–ï¼‰

ä¸»é“¾ï¼š`created â†’ assigned â†’ picked_up â†’ in_transit â†’ delivered â†’ completed`ï¼›åˆ†æ”¯ï¼š`exception`ã€`canceled`ã€‚

æ¢å¤ç­–ç•¥ï¼š
- å¹‚ç­‰ï¼šæ‰€æœ‰çŠ¶æ€æ›´æ–°éœ€æºå¸¦ `idempotencyKey`ï¼›é‡å¤æäº¤ä¸æ”¹å˜ç»“æœã€‚
- é‡è¯•ï¼šç½‘ç»œ/æš‚å¤±è´¥é‡‡ç”¨æŒ‡æ•°é€€é¿ï¼ˆæœ€å¤š 3 æ¬¡ï¼‰ã€‚
- è¡¥å¿ï¼šè®¡è´¹å¤±è´¥å›æ»šå˜æ›´ï¼Œä¿æŒåœ¨ deliveredï¼›å¿…è¦æ—¶äººå·¥ä»‹å…¥ã€‚
- å›æ»šç‚¹ï¼šcreated/assigned/delivered è®¾ç½®é€»è¾‘å›æ»šç‚¹ï¼Œexception æ¢å¤åˆ°ä¸Šä¸€æ­£å¸¸çŠ¶æ€ã€‚

æ•°æ®ä¸€è‡´æ€§ï¼štimeline ä»…è¿½åŠ ï¼›å®Œæˆå‰æ ¡éªŒ finalCostï¼›å–æ¶ˆé‡Šæ”¾å¸æœºã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 20. è´¢åŠ¡ç»„ä»¶åˆ†è§£ä¸ç¤ºä¾‹è®¡ç®—ï¼ˆå«ç¨/æŠ˜æ‰£ä¼˜å…ˆçº§ï¼‰

ç»„ä»¶ï¼šBase(åŸºç¡€ä»·)ã€Fees(é™„åŠ è´¹)ã€Discounts(æŠ˜æ‰£)ã€Tax(ç¨)ã€FX(æ±‡ç‡)ã€Rounding(èˆå…¥)ã€‚

æ¨èé¡ºåºï¼ˆé»˜è®¤ï¼‰ï¼š
1) Subtotal = Base + Î£Fees  
2) AfterDiscount = round(Subtotal Ã— (1 - D), 2)  
3) Total = round(AfterDiscount Ã— (1 + Tax), 2)

å¯é…ç½®ï¼šæ”¯æŒâ€œå…ˆç¨åæŠ˜æ‰£â€ä½œä¸ºç§Ÿæˆ·åè®®é€‰é¡¹ï¼Œä½†éœ€åœ¨å®¡è®¡ä¸­è®°å½•æ‰€ç”¨ç­–ç•¥ç‰ˆæœ¬ã€‚

ç¤ºä¾‹ï¼šBase=100, Fees=20, D=10%, Tax=13% â†’ AfterDiscount=108.00 â†’ Total=122.04ã€‚

å¹‚ç­‰ï¼šä½¿ç”¨ï¼ˆshipmentId + pricingVersion + paramsHashï¼‰ä½œä¸ºè®¡ç®—å¹‚ç­‰é”®ï¼›è¾“å‡ºå†™å…¥ financial_componentï¼Œè®°å½•é¡ºåºä¸èˆå…¥å‰åå€¼ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 21. å®¡è®¡ & å¹‚ç­‰ç­–ç•¥è¯´æ˜ï¼ˆç»†åŒ–ï¼‰

å®¡è®¡èŒƒå›´ï¼šè°/ä½•æ—¶/æ¥æº/å¯¹è±¡/å­—æ®µå‰åå€¼ï¼›æ•æ„Ÿå­—æ®µè„±æ•å­˜å‚¨ï¼›å¯å¯¼å‡ºæŠ¥è¡¨ï¼ˆCSV/Parquetï¼‰ã€‚

å¹‚ç­‰é”®è®¾è®¡ï¼š
- åˆ›å»ºï¼šexternalOrderNo+tenantId æˆ– idempotencyKey
- çŠ¶æ€æ›´æ–°ï¼šshipmentId+targetStatus+idempotencyKey
- è´¢åŠ¡ç”Ÿæˆï¼šshipmentId+type å”¯ä¸€
- è§„åˆ™å‘å¸ƒï¼šruleId+version å”¯ä¸€

ç•™å­˜ï¼šâ‰¥365 å¤©ï¼›è®¿é—®æ§åˆ¶ï¼šAUDITOR å¯è§è„±æ•å‰ï¼ˆéœ€å®¡æ‰¹ï¼‰ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 22. æŒ‡æ ‡/ç›‘æ§ & æŠ¥è­¦é˜ˆå€¼ï¼ˆé»˜è®¤ï¼‰

å…³é”®æŒ‡æ ‡ï¼š
- API æˆåŠŸç‡ã€P50/P95/P99 å»¶è¿Ÿï¼ˆåˆ›å»º/çŠ¶æ€æ›´æ–°/è§„åˆ™æ‰§è¡Œï¼‰
- dispatch_wait_timeã€pickup_delay_rateã€completion_latencyã€exception_rate
- financial_gen_delayã€audit_write_error_rate

é»˜è®¤é˜ˆå€¼ï¼ˆå¯æŒ‰ç¯å¢ƒè°ƒæ•´ï¼‰ï¼š
- åˆ›å»º/çŠ¶æ€æ›´æ–° P95 < 300msï¼›æˆåŠŸç‡ > 99.5%
- è®¡è´¹å¤±è´¥ç‡ < 0.5%ï¼›å®¡è®¡è½åº“å¤±è´¥ç‡ < 0.1%
- æŠ¥è­¦æ”¶æ•›ï¼š5 åˆ†é’Ÿçª—å£ï¼ŒæŠ–åŠ¨æŠ‘åˆ¶ï¼›åˆ†çº§å‘Šè­¦ä¸å€¼ç­è½®å€¼

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 23. è¿­ä»£ Roadmap & é£é™©ç™»è®°è¡¨ï¼ˆæ±‡æ€»ï¼‰

Roadmapï¼ˆç¤ºä¾‹ï¼‰ï¼š
- M1ï¼šçŠ¶æ€æœºç¨³å®š + è´¢åŠ¡é—­ç¯ + å®¡è®¡/å¹‚ç­‰ï¼ˆæœ¬æœŸï¼‰
- M2ï¼šå¯¼å…¥/æ‰¹é‡ã€å¼‚å¸¸ä»ªè¡¨ç›˜ã€æƒé™ç»†åŒ–çŸ©é˜µè½åœ°
- M3ï¼šè§„åˆ™å¼•æ“ pricing MVPï¼ˆåªåšé¢„ä¼°ï¼‰ + æŒ‡æ ‡ä»ªè¡¨æ¿
- M4ï¼špayroll è§„åˆ™ + å¤šå¸ç§/æ±‡ç‡

é£é™©ç™»è®°ï¼š
é£é™© | æ¦‚ç‡ | å½±å“ | ç­‰çº§ | ç¼“è§£
-----|------|------|------|-----
è§„åˆ™è¯¯é…å¯¼è‡´è´¹ç”¨å¼‚å¸¸ | ä¸­ | é«˜ | é«˜ | å®¡æ‰¹+ç°åº¦+é™é¢+å›æ»š
çŠ¶æ€æœºé‡å¤æ¨è¿› | ä¸­ | ä¸­ | ä¸­ | å¹‚ç­‰é”®+æœåŠ¡ç«¯æ ¡éªŒ
è´¢åŠ¡é‡‘é¢è¯¯å·® | ä½ | é«˜ | ä¸­ | ç‰ˆæœ¬åŒ–å‚æ•°+åŒäººå¤æ ¸+å›æ”¾
æ€§èƒ½ç“¶é¢ˆ | ä¸­ | ä¸­ | ä¸­ | å‹æµ‹+ç¼“å­˜+é™çº§

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 24. æ•°æ®åº“ DDL è‰æ¡ˆï¼ˆæ ¸å¿ƒè¡¨ï¼‰

æ³¨ï¼šä»¥ä¸‹ä¸ºé€»è¾‘ DDL å»ºè®®ï¼Œå®é™…ä»¥æ‰€é€‰æ•°æ®åº“æ–¹è¨€ä¸ºå‡†ï¼ˆPostgreSQL æ¨èï¼‰ã€‚

```sql
-- shipmentï¼ˆè¿å•ä¸»è¡¨ï¼‰
CREATE TABLE shipment (
  id               UUID PRIMARY KEY,
  tenant_id        UUID NOT NULL,
  shipment_no      VARCHAR(20) NOT NULL UNIQUE,
  external_order_no VARCHAR(50),
  sales_channel    VARCHAR(20) DEFAULT 'DIRECT',
  status           VARCHAR(20) NOT NULL,
  driver_id        UUID,
  estimated_cost   NUMERIC(12,2),
  final_cost       NUMERIC(12,2),
  cost_currency    CHAR(3) DEFAULT 'CNY',
  pricing_components JSONB DEFAULT '[]',
  pricing_rule_trace JSONB DEFAULT '[]',
  created_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  created_by       UUID,
  updated_at       TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_by       UUID
);
CREATE INDEX idx_shipment_tenant_status_created ON shipment(tenant_id, status, created_at DESC);

-- shipment_partyï¼ˆå‘/æ”¶ä»¶ï¼‰
CREATE TABLE shipment_party (
  id UUID PRIMARY KEY,
  shipment_id UUID NOT NULL REFERENCES shipment(id) ON DELETE CASCADE,
  role VARCHAR(16) NOT NULL, -- SHIPPER/RECEIVER
  name VARCHAR(50) NOT NULL,
  company VARCHAR(80),
  contact_name VARCHAR(50),
  phone VARCHAR(20) NOT NULL,
  email VARCHAR(80),
  country CHAR(2) NOT NULL,
  province VARCHAR(50),
  city VARCHAR(50) NOT NULL,
  postal_code VARCHAR(20),
  address_line1 VARCHAR(200) NOT NULL,
  address_line2 VARCHAR(200),
  is_residential BOOLEAN DEFAULT false
);
CREATE INDEX idx_party_shipment_role ON shipment_party(shipment_id, role);

-- shipment_package
CREATE TABLE shipment_package (
  id UUID PRIMARY KEY,
  shipment_id UUID NOT NULL REFERENCES shipment(id) ON DELETE CASCADE,
  box_name VARCHAR(40),
  length NUMERIC(8,2) NOT NULL,
  width  NUMERIC(8,2) NOT NULL,
  height NUMERIC(8,2) NOT NULL,
  dimension_unit VARCHAR(8) NOT NULL,
  weight NUMERIC(10,3) NOT NULL,
  weight_unit VARCHAR(8) NOT NULL,
  declared_value NUMERIC(12,2) DEFAULT 0,
  currency CHAR(3) DEFAULT 'CNY',
  remark VARCHAR(200)
);
CREATE INDEX idx_package_shipment ON shipment_package(shipment_id);

-- shipment_itemï¼ˆå•†å“ï¼‰
CREATE TABLE shipment_item (
  id UUID PRIMARY KEY,
  shipment_id UUID NOT NULL REFERENCES shipment(id) ON DELETE CASCADE,
  package_id UUID,
  sku VARCHAR(40),
  description VARCHAR(200),
  hs_code VARCHAR(10),
  quantity INTEGER NOT NULL,
  unit_weight NUMERIC(10,3),
  unit_price NUMERIC(12,2),
  currency CHAR(3) DEFAULT 'CNY',
  origin_country CHAR(2)
);
CREATE INDEX idx_item_shipment ON shipment_item(shipment_id);

-- shipment_timeline
CREATE TABLE shipment_timeline (
  id UUID PRIMARY KEY,
  shipment_id UUID NOT NULL REFERENCES shipment(id) ON DELETE CASCADE,
  event_type VARCHAR(32) NOT NULL,
  from_status VARCHAR(20),
  to_status VARCHAR(20),
  actor_type VARCHAR(16) NOT NULL,
  actor_id UUID,
  ts TIMESTAMPTZ NOT NULL DEFAULT now(),
  extra JSONB
);
CREATE INDEX idx_timeline_shipment_ts ON shipment_timeline(shipment_id, ts DESC);

-- financial_record
CREATE TABLE financial_record (
  id UUID PRIMARY KEY,
  shipment_id UUID NOT NULL REFERENCES shipment(id) ON DELETE CASCADE,
  type VARCHAR(16) NOT NULL, -- receivable/payable
  party_id UUID,
  amount NUMERIC(12,2) NOT NULL,
  currency CHAR(3) NOT NULL DEFAULT 'CNY',
  status VARCHAR(16) NOT NULL DEFAULT 'pending',
  generated_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  paid_at TIMESTAMPTZ
);
CREATE UNIQUE INDEX uq_financial_shipment_type ON financial_record(shipment_id, type);

-- financial_component
CREATE TABLE financial_component (
  id UUID PRIMARY KEY,
  financial_record_id UUID NOT NULL REFERENCES financial_record(id) ON DELETE CASCADE,
  code VARCHAR(32) NOT NULL,
  label VARCHAR(64),
  amount NUMERIC(12,2) NOT NULL,
  sequence INTEGER NOT NULL
);
CREATE INDEX idx_fin_comp_record ON financial_component(financial_record_id);

-- ruleï¼ˆé¢„ç•™ï¼‰
CREATE TABLE rule (
  id UUID PRIMARY KEY,
  type VARCHAR(16) NOT NULL, -- pricing/payroll
  tenant_id UUID NOT NULL,
  priority INTEGER NOT NULL DEFAULT 0,
  conditions JSONB NOT NULL,
  actions JSONB NOT NULL,
  enabled BOOLEAN NOT NULL DEFAULT true,
  version INTEGER NOT NULL DEFAULT 1,
  created_at TIMESTAMPTZ NOT NULL DEFAULT now(),
  updated_at TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX idx_rule_tenant_type ON rule(tenant_id, type, enabled, priority DESC);

-- audit_log
CREATE TABLE audit_log (
  id UUID PRIMARY KEY,
  entity_type VARCHAR(32) NOT NULL,
  entity_id UUID NOT NULL,
  field VARCHAR(64),
  old_value TEXT,
  new_value TEXT,
  actor_id UUID,
  actor_type VARCHAR(16),
  ts TIMESTAMPTZ NOT NULL DEFAULT now()
);
CREATE INDEX idx_audit_entity_ts ON audit_log(entity_type, entity_id, ts DESC);
```

ç´¢å¼•ä¸çº¦æŸå»ºè®®ï¼š
- é¿å…è·¨ç§Ÿæˆ·æ‰«æï¼šæ‰€æœ‰æ ¸å¿ƒæŸ¥è¯¢å‡ä»¥ tenant_id ä¸ºé¦–åˆ—å»ºç«‹å¤åˆç´¢å¼•ã€‚
- æ—¶é—´åºæŸ¥è¯¢ï¼štimeline/financial æŒ‰ ts/created_at é™åºç´¢å¼•ã€‚
- é‡‘é¢å­—æ®µ NUMERICï¼Œç»Ÿä¸€ä¸¤ä½å°æ•°ï¼Œè®¡ç®—å±‚æ§åˆ¶èˆå…¥ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 25. è§„åˆ™ DSL JSON Schemaï¼ˆå»ºè®®ï¼‰

```json
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Rule",
  "type": "object",
  "properties": {
    "id": { "type": "string" },
    "type": { "enum": ["pricing", "payroll"] },
    "tenantId": { "type": "string" },
    "priority": { "type": "integer", "minimum": 0 },
    "enabled": { "type": "boolean" },
    "conditions": {
      "type": "object",
      "properties": {
        "op": { "enum": ["AND", "OR"] },
        "children": {
          "type": "array",
          "items": {
            "anyOf": [
              { "$ref": "#/definitions/condition" },
              { "$ref": "#/definitions/group" }
            ]
          },
          "maxItems": 20
        }
      },
      "required": ["op", "children"]
    },
    "actions": {
      "type": "array",
      "items": { "$ref": "#/definitions/action" },
      "maxItems": 20
    }
  },
  "required": ["type", "tenantId", "priority", "conditions", "actions"],
  "definitions": {
    "condition": {
      "type": "object",
      "properties": {
        "field": { "type": "string" },
        "operator": { "enum": ["=","!=","<","<=",">",">=","IN","NOT_IN","STARTS_WITH","ENDS_WITH","CONTAINS"] },
        "value": {}
      },
      "required": ["field", "operator", "value"]
    },
    "group": {
      "type": "object",
      "properties": {
        "op": { "enum": ["AND", "OR"] },
        "children": { "type": "array", "items": { "$ref": "#/definitions/condition" } }
      },
      "required": ["op", "children"]
    },
    "action": {
      "type": "object",
      "properties": {
        "type": { "enum": ["addFee","applyDiscount","setTax","setFinalPrice","setDriverCommission","stopProcessing"] },
        "params": { "type": "object" }
      },
      "required": ["type"]
    }
  }
}
```

è¯´æ˜ï¼šä»…å…è®¸ç™½åå•å­—æ®µä¸åŠ¨ä½œï¼›å¼•æ“åŠ è½½æ—¶è¿›è¡Œé™æ€æ ¡éªŒä¸é™é¢æ£€æŸ¥ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 26. é©±åŠ¨è°ƒåº¦ç­–ç•¥ï¼ˆåˆç¨¿ï¼‰

ç›®æ ‡ï¼šåœ¨ created/unassigned é˜¶æ®µï¼ŒæŒ‰â€œå¯ç”¨æ€§ã€è·ç¦»ã€è´Ÿè½½â€æ‹©ä¼˜åˆ†é…ã€‚

è¾“å…¥ï¼šshipment èµ·ç‚¹/ç»ˆç‚¹ã€åŒ…è£¹é‡é‡ä½“ç§¯ã€æ—¶é—´çª—ï¼›å¸æœºå½“å‰ä½ç½®/çŠ¶æ€/è´Ÿè½½/èƒ½åŠ›ï¼ˆå†·é“¾ï¼‰ã€‚

è¯„ä»·å‡½æ•°ï¼ˆç¤ºä¾‹ï¼‰ï¼š
- score = w1Ã—availability + w2Ã—distanceScore + w3Ã—loadScore + w4Ã—capabilityMatch
- å¯ç”¨æ€§ï¼šåœ¨çº¿ä¸”ç©ºé—² = 1ï¼Œå¦åˆ™ 0
- è·ç¦»åˆ†ï¼šè¿‘è·ç¦»å¾—åˆ†é«˜ï¼ˆåæ¯”ï¼‰
- è´Ÿè½½åˆ†ï¼šå·²åˆ†é…æ•°è¶Šå°‘å¾—åˆ†è¶Šé«˜
- èƒ½åŠ›åŒ¹é…ï¼šè¦æ±‚å†·é“¾ä¸”å¸æœºæ”¯æŒ=åŠ åˆ†

çº¦æŸï¼šæ¯åå¸æœºæœ€å¤§å¹¶å‘å•æ•°ï¼›åŒåŸä¼˜å…ˆï¼›é»‘åå•/ç™½åå•ï¼›äººå·¥ overrideã€‚

è¾“å‡ºï¼šæ¨è Top-N å¸æœºåˆ—è¡¨ï¼›æ”¯æŒä¸€é”®åˆ†é…ä¸äººå·¥é€‰æ‹©ã€‚

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 27. å¸æœºç§»åŠ¨ç«¯äº¤äº’ä¸æƒé™ç»†åŒ–

åŠŸèƒ½ï¼š
- ç™»å½•ä¸æ¥å•åˆ—è¡¨ï¼ˆä»…æœ¬äººï¼‰
- æŸ¥çœ‹è¿å•è¦ç‚¹ï¼ˆåœ°å€/è”ç³»äººéƒ¨åˆ†è„±æ•ï¼‰
- ä¸€é”®çŠ¶æ€æ›´æ–°ï¼špicked_up / in_transit / delivered
- ä¸Šä¼ ç­¾æ”¶ç…§ç‰‡/ç­¾æ”¶ç ï¼ˆæœªæ¥ï¼‰

æƒé™ï¼š
- ä»…å¯è®¿é—® `assigned` ç»™è‡ªå·±çš„è¿å•
- ä¸å¯æŸ¥çœ‹è´¹ç”¨æ˜ç»†/å®¢æˆ·éšç§å®Œæ•´ä¿¡æ¯
- æ“ä½œé¢‘æ¬¡é™åˆ¶ä¸ä½ç½®æ ¡éªŒï¼ˆå¯é€‰ï¼‰

å¼‚å¸¸ï¼š
- æ— ç½‘ç»œç¦»çº¿ç¼“å­˜ï¼Œæ¢å¤åè¡¥ä¼ 
- é‡å¤ç‚¹å‡»é€šè¿‡å¹‚ç­‰é”®ä¿è¯ä¸€æ¬¡

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 28. å¼‚å¸¸åˆ†ç±»ä»£ç è¡¨ï¼ˆå»ºè®®ï¼‰

ä»£ç  | åç§° | è¯´æ˜ | æ˜¯å¦ç»ˆæ­¢
----|-----|-----|------
DELAY | å»¶è¿Ÿ | æœªæŒ‰æ—¶å–/é€ | å¦
DAMAGE | è´§æŸ | è´§ç‰©æŸå | è§†ä¸¥é‡åº¦
LOST | ä¸¢å¤± | è´§ç‰©é—å¤± | æ˜¯
PARTIAL_LOSS | éƒ¨åˆ†ä¸¢å¤± | éƒ¨åˆ†è´§ç‰©ç¼ºå¤± | è§†æƒ…å†µ
ADDRESS_ISSUE | åœ°å€é—®é¢˜ | åœ°å€ä¸è¯¦/é”™è¯¯ | å¦
WEATHER | å¤©æ°” | å¤©ç¾å¯¼è‡´æ— æ³•æŒ‰æ—¶ | å¦
OTHER | å…¶ä»– | å…¶ä»–å¼‚å¸¸ | å¦

<!-- Added by assistant @ 2025-09-29 09:12:36 -->
## 29. API é”™è¯¯ç æ ‡å‡†ï¼ˆå»ºè®®ï¼‰

ç»“æ„ï¼š`{ code, message, details?, traceId }`

å‘½åï¼š
- é€šç”¨ï¼š`COM_4xx/5xx`
- è®¤è¯æˆæƒï¼š`AUTH_4xx`
- æ ¡éªŒï¼š`VAL_xxxx`
- è¿å•ï¼š`WB_xxxx`
- è´¢åŠ¡ï¼š`FIN_xxxx`
- è§„åˆ™ï¼š`RULE_xxxx`

ç¤ºä¾‹ï¼š
- `VAL_1001` å‚æ•°ç¼ºå¤±/æ ¼å¼é”™è¯¯
- `AUTH_401` æœªæˆæƒ
- `WB_1002` é‡é‡/ä½“ç§¯ä¸ºè´Ÿ
- `FIN_2001` é‡‘é¢ä¸å¹³è¡¡
- `RULE_3001` è§„åˆ™åŒ…å«æœªæˆæƒå­—æ®µ

