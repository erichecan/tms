
# 智能物流运营平台 (TMS SaaS) - 产品需求文档 (PRD)

**版本:** 2.0 (基于代码分析)
**最后更新:** 2025-09-11

## 1. 产品概述

### 1.1 产品愿景
打造一个以规则引擎为核心、高度自动化和智能化的物流运营管理SaaS平台, 帮助中小型物流企业降本增效, 实现精细化运营, 提升市场竞争力.

### 1.2 目标用户

- **物流公司管理员:** 需要全面掌控公司运营数据, 配置业务规则, 管理员工和财务.
- **运营/调度人员:** 负责日常运单的创建、报价、分配和跟踪.
- **财务人员:** 负责客户对账、应收账款管理和司机薪酬结算.
- **司机:** (通过移动端或小程序)接收任务, 更新运单状态.

## 2. 功能需求

### 2.1 核心功能: 运单全生命周期管理

**用户故事:** 作为一名运营人员, 我希望能在一个地方完成从接单、报价、调度到跟踪和完成的所有操作, 以提高效率和减少错误.

**功能详述:**

- **运单创建:**
  - 支持录入客户信息、取货/送货地址、货物详情(重量、体积、描述等).
  - 系统根据租户设定的规则自动生成唯一的、带日期的运单号 (如 `TMS202509110001`).
  - 初始状态为 `pending`.

- **智能报价:**
  - 在创建或编辑运单时, 系统调用 **规则引擎服务**.
  - 将运单的上下文信息 (如 `cargoInfo.weight`, `cargoInfo.volume`, `pickupAddress.city`, `deliveryAddress.city`) 作为输入 "facts".
  - 规则引擎匹配租户定义的计费规则 (如 “重货按公斤计费”, “泡货按方计费”, “跨城基础费”), 计算出 `estimatedCost` (预估费用).
  - 运单状态变为 `quoted`.

- **运单确认与分配:**
  - 运营人员与客户确认报价后, 可将运单状态更新为 `confirmed`.
  - 运营人员从可用司机列表中选择一名司机, 将其分配给运单. 系统记录分配人 (`assignedBy`) 和分配时间.
  - 运单状态变为 `assigned`.

- **在途执行与跟踪:**
  - 司机通过移动设备(或由后台人员手动更新)按顺序更新运单状态: `picked_up` (已取货) -> `in_transit` (运输中) -> `delivered` (已送达).
  - 每次状态更新, 系统都会在运单的 `timeline` 字段中记录下精确的时间戳, 形成完整的执行轨迹.

- **运单完成与结算:**
  - 货物送达后, 运营或财务人员可将运单状态更新为 `completed`.
  - 在此步骤可以录入 `finalCost` (最终费用), 以处理可能存在的额外费用.
  - **(自动化触发)** 运单完成后, 系统自动调用 **薪酬计算服务**, 根据薪酬规则为该单的司机计算提成, 并生成一条 `payable` (应付) 类型的财务记录.
  - 同时, 系统为该单的客户生成一条 `receivable` (应收) 类型的财务记录.

- **异常处理:**
  - 在任何阶段, 运单都可以被 `cancel` (取消), 需填写取消原因.
  - 也可以标记为 `exception` 状态, 并记录异常备注.

### 2.2 核心功能: 动态规则引擎

**用户故事:** 作为公司管理员, 我希望能根据市场变化和公司策略, 随时调整我们的报价和司机薪酬计算方式, 而不需要找软件公司修改代码.

**功能详述:**

- **规则类型:** 系统支持两种核心规则: `pricing` (计费) 和 `payroll` (薪酬).
- **可视化编辑器:**
  - 提供一个图形化界面, 允许用户通过下拉菜单和输入框来构建 "IF...THEN..." 逻辑.
  - **条件 (IF):** 用户可以选择 "Fact" (事实, 如 `运单重量`), "Operator" (操作符, 如 `大于`), 和 "Value" (值, 如 `1000`). 支持 `AND`/`OR` 组合多个条件.
  - **动作 (THEN):** 用户可以定义满足条件时执行的操作, 如 `applyDiscount` (应用折扣), `addFee` (增加附加费), `setDriverCommission` (设置司机提成比例).
- **规则管理:**
  - 创建、编辑、复制和停用规则.
  - 设置规则的 `priority` (优先级), 解决规则冲突问题.

### 2.3 核心功能: 一体化财务管理

**用户故事:** 作为财务人员, 我希望系统能自动帮我把账算清楚, 我只需要审核和发送, 从而减少繁琐的手工对账工作.

**功能详述:**

- **自动记账:**
  - 每个 `completed` 状态的运单都会自动生成应收账款和应付薪酬两条财务记录.
- **应收管理:**
  - 提供应收账款列表, 可按客户、日期、状态 (`pending`, `paid`, `overdue`) 筛选.
  - 支持批量选择运单, 一键生成客户对账单 (PDF或Excel格式).
- **应付管理:**
  - 提供司机薪酬列表, 可按司机、日期、状态筛选.
  - 支持一键生成司机薪酬结算单.
- **收款/付款登记:** 支持手动标记某笔账款或薪酬为已支付.

## 3. 非功能需求

| 类别 | 需求描述 |
| :--- | :--- |
| **性能** | - 核心API (如报价、运单状态更新) 平均响应时间 < 500ms. |
| **安全性** | - 严格的租户数据隔离, 所有数据库查询必须经过租户ID过滤. |
| **可用性** | - 系统核心服务可用性需达到 99.9%. |
| **数据准确性** | - 所有财务计算必须保证准确无误, 提供审计日志以供追溯. |
