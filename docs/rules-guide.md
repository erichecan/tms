# 规则管理详细使用指南

## 创建时间
2025-11-30 07:00:00

## 概述

规则管理系统是TMS平台的核心功能之一，用于管理计费规则和司机薪酬规则。规则引擎基于 `json-rules-engine` 实现，支持复杂的条件判断和动作执行。

---

## 一、规则创建界面字段详解

### 1. 规则名称 (name) ⭐ 必填

**字段说明：** 规则的唯一标识名称，用于在规则列表中识别该规则。

**填写要求：**
- 长度：1-255个字符
- 格式：建议使用中文或英文，清晰描述规则用途
- 唯一性：同一租户内规则名称不能重复

**填写示例：**
- ✅ 正确：`基础运费规则`、`VIP客户折扣`、`危险品附加费`
- ❌ 错误：`规则1`、`test`、`运费`（太模糊）

**填写意义：** 帮助管理员快速识别规则用途，便于管理和维护。

---

### 2. 规则描述 (description) 可选

**字段说明：** 对规则的详细说明，包括规则的应用场景、计算逻辑等。

**填写要求：**
- 长度：建议不超过500个字符
- 内容：详细说明规则的业务逻辑、适用场景、注意事项

**填写示例：**
```
基础运费计算规则：适用于所有运单，按距离计算基础运费。
计算公式：基础运费 = 距离（公里）× 每公里费率（5元/公里）
```

**填写意义：** 
- 帮助团队成员理解规则的业务逻辑
- 便于后续维护和修改
- 作为规则文档的一部分

---

### 3. 规则类型 (type) ⭐ 必填

**字段说明：** 规则的应用类型，决定规则用于计费还是司机薪酬计算。

**可选值：**
- `pricing` - 计费规则：用于计算运单费用
- `payroll` - 司机薪酬规则：用于计算司机薪酬

**选择指南：**

**选择 `pricing` 的情况：**
- 计算运单的基础运费
- 计算距离费用、重量费用、体积费用
- 添加附加费用（危险品、周末配送等）
- 应用客户折扣

**选择 `payroll` 的情况：**
- 计算司机基础工资
- 计算行程提成
- 计算绩效奖金
- 根据客户级别设置提成比例

**填写示例：**
- 场景：计算运单费用 → 选择 `pricing`
- 场景：计算司机提成 → 选择 `payroll`

**填写意义：** 系统会根据规则类型将规则分类管理，并在相应的业务场景中应用。

---

### 4. 优先级 (priority) ⭐ 必填

**字段说明：** 规则的执行优先级，数字越大优先级越高，越先执行。

**填写要求：**
- 类型：整数
- 范围：建议 0-1000
- 默认值：100

**优先级设置原则：**

1. **基础规则（优先级 100-150）**
   - 适用于所有运单的基础计算
   - 示例：基础运费、距离费用

2. **特殊规则（优先级 150-200）**
   - 适用于特定条件的附加费用
   - 示例：危险品附加费、周末配送费

3. **折扣规则（优先级 200-300）**
   - 适用于客户折扣、优惠活动
   - 示例：VIP客户折扣、新客户优惠

4. **司机薪酬规则（优先级 300-400）**
   - 适用于司机薪酬计算
   - 示例：基础提成、高级客户提成

**执行顺序示例：**
```
优先级 200：VIP客户折扣（先执行）
优先级 150：危险品附加费
优先级 100：基础运费（后执行）
```

**填写示例：**
- 基础运费规则：`100`
- 危险品附加费：`150`
- VIP客户折扣：`200`
- 高级客户司机提成：`310`

**填写意义：** 
- 确保规则按正确顺序执行
- 避免规则冲突
- 实现复杂的计费逻辑组合

---

### 5. 条件 (conditions) ⭐ 必填

**字段说明：** 规则触发的条件，当所有条件都满足时，规则才会执行。

**数据结构：** JSON数组，每个元素是一个条件对象

**条件对象结构：**
```json
{
  "fact": "字段名",
  "operator": "操作符",
  "value": "比较值"
}
```

#### 5.1 事实 (fact) - 条件字段

**可用的事实字段：**

**运单相关事实：**
- `distance` - 距离（公里，数字）
- `weight` - 重量（公斤，数字）
- `volume` - 体积（立方米，数字）
- `isHazardous` - 是否危险品（布尔值：true/false）
- `weekendDelivery` - 是否周末配送（布尔值：true/false）
- `customerLevel` - 客户级别（字符串：'vip' | 'premium' | 'standard'）
- `pickupCity` - 取货城市（字符串）
- `deliveryCity` - 送货城市（字符串）
- `shipmentStatus` - 运单状态（字符串）

**司机相关事实（仅用于payroll规则）：**
- `driverLevel` - 司机等级（字符串）
- `driverRating` - 司机评分（数字）
- `totalDeliveries` - 总配送次数（数字）
- `onTimeRate` - 准时率（数字，0-100）

**填写示例：**
```json
{
  "fact": "distance",
  "operator": "greaterThan",
  "value": 100
}
```
含义：当距离大于100公里时

**填写意义：** 指定要检查的数据字段，这是条件判断的基础。

---

#### 5.2 操作符 (operator) - 比较方式

**支持的操作符：**

| 操作符 | 说明 | 适用数据类型 | 示例 |
|--------|------|-------------|------|
| `equal` | 等于 | 字符串、数字、布尔值 | `"customerLevel" equal "vip"` |
| `notEqual` | 不等于 | 字符串、数字、布尔值 | `"isHazardous" notEqual true` |
| `greaterThan` | 大于 | 数字 | `"distance" greaterThan 100` |
| `lessThan` | 小于 | 数字 | `"weight" lessThan 1000` |
| `greaterThanInclusive` | 大于等于 | 数字 | `"distance" greaterThanInclusive 50` |
| `lessThanInclusive` | 小于等于 | 数字 | `"weight" lessThanInclusive 2000` |
| `in` | 包含在数组中 | 字符串、数字 | `"customerLevel" in ["vip", "premium"]` |
| `notIn` | 不包含在数组中 | 字符串、数字 | `"pickupCity" notIn ["北京", "上海"]` |
| `contains` | 字符串包含 | 字符串 | `"pickupCity" contains "北京"` |

**填写示例：**
```json
{
  "fact": "customerLevel",
  "operator": "equal",
  "value": "vip"
}
```
含义：客户级别等于 "vip"

**填写意义：** 定义如何比较事实值和目标值，决定条件是否满足。

---

#### 5.3 值 (value) - 比较目标

**字段说明：** 与事实字段比较的目标值。

**数据类型：**
- 数字：`100`、`50.5`
- 字符串：`"vip"`、`"北京"`
- 布尔值：`true`、`false`
- 数组：`["vip", "premium"]`（仅用于 `in` 和 `notIn` 操作符）

**填写示例：**
```json
{
  "fact": "distance",
  "operator": "greaterThan",
  "value": 100
}
```
含义：距离大于100公里

**填写意义：** 设置条件判断的阈值或目标值。

---

#### 5.4 组合条件

**多个条件的组合：**

系统使用 `all`（所有条件都必须满足）逻辑：

```json
{
  "all": [
    {
      "fact": "distance",
      "operator": "greaterThan",
      "value": 100
    },
    {
      "fact": "customerLevel",
      "operator": "equal",
      "value": "vip"
    }
  ]
}
```

含义：距离大于100公里 **并且** 客户级别是VIP

**填写示例（完整条件数组）：**
```json
[
  {
    "fact": "distance",
    "operator": "greaterThan",
    "value": 0
  },
  {
    "fact": "customerLevel",
    "operator": "in",
    "value": ["vip", "premium"]
  }
]
```

**填写意义：** 实现复杂的业务逻辑判断，确保规则只在特定场景下触发。

---

### 6. 动作 (actions) ⭐ 必填

**字段说明：** 当条件满足时执行的操作，定义规则的具体业务逻辑。

**数据结构：** JSON数组，每个元素是一个动作对象

**动作对象结构：**
```json
{
  "type": "动作类型",
  "params": {
    "参数名": "参数值"
  }
}
```

#### 6.1 计费规则动作 (pricing)

**1. calculateBaseFee - 计算基础费用**

**用途：** 根据距离计算基础运费

**参数：**
- `ratePerKm` - 每公里费率（数字，必填）

**填写示例：**
```json
{
  "type": "calculateBaseFee",
  "params": {
    "ratePerKm": 5
  }
}
```
含义：按每公里5元计算基础运费

**计算公式：** 基础运费 = 距离（公里）× ratePerKm

---

**2. addFee - 添加固定费用**

**用途：** 添加固定的附加费用

**参数：**
- `amount` - 费用金额（数字，必填）
- `description` - 费用说明（字符串，可选）

**填写示例：**
```json
{
  "type": "addFee",
  "params": {
    "amount": 200,
    "description": "危险品附加费"
  }
}
```
含义：添加200元的危险品附加费

---

**3. applyDiscount - 应用折扣**

**用途：** 对总费用应用百分比折扣

**参数：**
- `percentage` - 折扣百分比（数字，0-100，必填）

**填写示例：**
```json
{
  "type": "applyDiscount",
  "params": {
    "percentage": 10
  }
}
```
含义：应用10%的折扣（即打9折）

**计算公式：** 折扣后金额 = 原金额 × (1 - percentage / 100)

---

**4. calculateDistanceFee - 计算距离费用**

**用途：** 根据距离计算费用（与基础费用类似，但可以设置不同的费率）

**参数：**
- `ratePerKm` - 每公里费率（数字，必填）
- `minDistance` - 最小距离（数字，可选，默认0）
- `maxDistance` - 最大距离（数字，可选）

**填写示例：**
```json
{
  "type": "calculateDistanceFee",
  "params": {
    "ratePerKm": 3,
    "minDistance": 50
  }
}
```
含义：距离超过50公里时，按每公里3元计算距离费用

---

**5. calculateWeightFee - 计算重量费用**

**用途：** 根据重量计算费用

**参数：**
- `ratePerKg` - 每公斤费率（数字，必填）
- `minWeight` - 最小重量（数字，可选，默认0）

**填写示例：**
```json
{
  "type": "calculateWeightFee",
  "params": {
    "ratePerKg": 2,
    "minWeight": 100
  }
}
```
含义：重量超过100公斤时，按每公斤2元计算重量费用

---

#### 6.2 司机薪酬规则动作 (payroll)

**1. setDriverCommission - 设置司机提成**

**用途：** 设置司机提成比例

**参数：**
- `percentage` - 提成百分比（数字，0-100，必填）

**填写示例：**
```json
{
  "type": "setDriverCommission",
  "params": {
    "percentage": 30
  }
}
```
含义：设置司机提成为30%

**计算公式：** 司机提成 = 运单费用 × percentage / 100

---

**2. addDriverBonus - 添加司机奖金**

**用途：** 添加固定的司机奖金

**参数：**
- `amount` - 奖金金额（数字，必填）
- `description` - 奖金说明（字符串，可选）

**填写示例：**
```json
{
  "type": "addDriverBonus",
  "params": {
    "amount": 500,
    "description": "月度绩效奖金"
  }
}
```
含义：添加500元的月度绩效奖金

---

**3. setBaseSalary - 设置基础工资**

**用途：** 设置司机的基础工资

**参数：**
- `amount` - 基础工资金额（数字，必填）

**填写示例：**
```json
{
  "type": "setBaseSalary",
  "params": {
    "amount": 3000
  }
}
```
含义：设置基础工资为3000元

---

#### 6.3 动作组合

**多个动作的执行：**

动作按顺序执行，可以组合多个动作：

```json
[
  {
    "type": "calculateBaseFee",
    "params": {
      "ratePerKm": 5
    }
  },
  {
    "type": "addFee",
    "params": {
      "amount": 200,
      "description": "危险品附加费"
    }
  }
]
```

含义：先计算基础运费，然后添加危险品附加费

**填写意义：** 实现复杂的计费逻辑，通过组合多个动作完成完整的费用计算。

---

### 7. 状态 (status) 可选

**字段说明：** 规则是否激活

**可选值：**
- `active` - 激活：规则会被执行
- `inactive` - 停用：规则不会被执行

**默认值：** `active`

**使用场景：**
- 创建新规则时，建议先设置为 `inactive`，测试通过后再设置为 `active`
- 需要临时停用规则时，设置为 `inactive`
- 需要重新启用规则时，设置为 `active`

**填写示例：**
- 新规则测试阶段：`inactive`
- 规则正式使用：`active`
- 规则需要维护：`inactive`

**填写意义：** 控制规则是否生效，便于规则管理和维护。

---

## 二、规则创建完整示例

### 示例1：基础运费规则

**场景：** 所有运单都需要计算基础运费，按每公里5元计算。

**填写步骤：**

1. **规则名称：** `基础运费规则`
2. **规则描述：** `适用于所有运单的基础运费计算，按距离计算，每公里5元`
3. **规则类型：** `pricing`
4. **优先级：** `100`
5. **条件：**
```json
[
  {
    "fact": "distance",
    "operator": "greaterThan",
    "value": 0
  }
]
```
6. **动作：**
```json
[
  {
    "type": "calculateBaseFee",
    "params": {
      "ratePerKm": 5
    }
  }
]
```
7. **状态：** `active`

**业务逻辑：** 当运单距离大于0公里时，按每公里5元计算基础运费。

---

### 示例2：危险品附加费规则

**场景：** 运输危险品时，额外收取200元附加费。

**填写步骤：**

1. **规则名称：** `危险品附加费`
2. **规则描述：** `当运单包含危险品时，额外收取200元附加费`
3. **规则类型：** `pricing`
4. **优先级：** `150`（高于基础运费，先执行）
5. **条件：**
```json
[
  {
    "fact": "isHazardous",
    "operator": "equal",
    "value": true
  }
]
```
6. **动作：**
```json
[
  {
    "type": "addFee",
    "params": {
      "amount": 200,
      "description": "危险品附加费"
    }
  }
]
```
7. **状态：** `active`

**业务逻辑：** 当运单包含危险品时，添加200元的附加费。

---

### 示例3：VIP客户折扣规则

**场景：** VIP客户享受10%的折扣。

**填写步骤：**

1. **规则名称：** `VIP客户折扣`
2. **规则描述：** `VIP客户享受10%的折扣优惠`
3. **规则类型：** `pricing`
4. **优先级：** `200`（最高优先级，最后执行，对总费用打折）
5. **条件：**
```json
[
  {
    "fact": "customerLevel",
    "operator": "equal",
    "value": "vip"
  }
]
```
6. **动作：**
```json
[
  {
    "type": "applyDiscount",
    "params": {
      "percentage": 10
    }
  }
]
```
7. **状态：** `active`

**业务逻辑：** 当客户级别为VIP时，对总费用应用10%的折扣。

---

### 示例4：高级客户司机提成规则

**场景：** 高级客户的运单，司机提成为35%。

**填写步骤：**

1. **规则名称：** `高级客户司机提成`
2. **规则描述：** `高级客户的运单，司机提成为35%`
3. **规则类型：** `payroll`
4. **优先级：** `310`
5. **条件：**
```json
[
  {
    "fact": "customerLevel",
    "operator": "equal",
    "value": "premium"
  }
]
```
6. **动作：**
```json
[
  {
    "type": "setDriverCommission",
    "params": {
      "percentage": 35
    }
  }
]
```
7. **状态：** `active`

**业务逻辑：** 当客户级别为高级（premium）时，设置司机提成为35%。

---

### 示例5：长距离运费优惠规则

**场景：** 距离超过200公里的运单，每公里费率降低到4元。

**填写步骤：**

1. **规则名称：** `长距离运费优惠`
2. **规则描述：** `距离超过200公里的运单，每公里费率优惠为4元`
3. **规则类型：** `pricing`
4. **优先级：** `120`（高于基础运费100，会覆盖基础运费）
5. **条件：**
```json
[
  {
    "fact": "distance",
    "operator": "greaterThan",
    "value": 200
  }
]
```
6. **动作：**
```json
[
  {
    "type": "calculateBaseFee",
    "params": {
      "ratePerKm": 4
    }
  }
]
```
7. **状态：** `active`

**业务逻辑：** 当距离超过200公里时，按每公里4元计算基础运费（覆盖默认的5元费率）。

---

## 三、规则执行流程

### 规则执行顺序

1. **按优先级排序**：优先级数字越大，越先执行
2. **检查条件**：遍历所有激活的规则，检查条件是否满足
3. **执行动作**：如果条件满足，执行规则的动作
4. **继续检查**：继续检查下一个规则
5. **返回结果**：所有规则执行完毕后，返回最终结果

### 执行示例

假设有以下规则：

1. 优先级 200：VIP客户折扣（条件：客户级别 = vip，动作：10%折扣）
2. 优先级 150：危险品附加费（条件：是危险品，动作：+200元）
3. 优先级 100：基础运费（条件：距离 > 0，动作：5元/公里）

**执行流程（距离100公里，VIP客户，非危险品）：**

1. 执行优先级200规则：条件满足（VIP客户）→ 应用10%折扣（但此时总费用还未计算）
2. 执行优先级150规则：条件不满足（非危险品）→ 跳过
3. 执行优先级100规则：条件满足（距离 > 0）→ 计算基础运费 = 100 × 5 = 500元
4. 最终费用 = 500元
5. 应用折扣：500 × 0.9 = 450元

**最终结果：** 450元

---

## 四、规则管理最佳实践

### 1. 规则命名规范

- ✅ 使用清晰的中文或英文名称
- ✅ 包含规则类型和用途
- ✅ 避免使用模糊的名称

**示例：**
- ✅ `基础运费规则`
- ✅ `VIP客户折扣`
- ❌ `规则1`
- ❌ `运费`

### 2. 优先级设置建议

- **基础规则**：100-150
- **特殊规则**：150-200
- **折扣规则**：200-300
- **薪酬规则**：300-400

### 3. 条件设计原则

- ✅ 条件要具体明确
- ✅ 避免条件重叠
- ✅ 使用合适的操作符
- ❌ 避免过于复杂的条件组合

### 4. 动作设计原则

- ✅ 动作参数要合理
- ✅ 避免重复计算
- ✅ 考虑规则组合效果
- ❌ 避免动作冲突

### 5. 测试规则

创建规则后：
1. 先设置为 `inactive` 状态
2. 使用规则测试功能验证
3. 使用不同的输入数据测试
4. 验证规则执行结果
5. 确认无误后设置为 `active`

---

## 五、常见问题解答

### Q1: 规则不生效怎么办？

**检查清单：**
1. ✅ 规则状态是否为 `active`
2. ✅ 规则条件是否正确
3. ✅ 输入数据是否满足条件
4. ✅ 规则优先级是否合适
5. ✅ 是否有其他规则覆盖

### Q2: 如何调试规则？

**方法：**
1. 使用规则测试功能
2. 查看规则执行日志
3. 检查规则执行顺序
4. 验证输入数据

### Q3: 规则可以删除吗？

**建议：**
1. 先设置为 `inactive` 停用
2. 观察一段时间确认无影响
3. 再删除规则

### Q4: 如何避免规则冲突？

**方法：**
1. 合理设置优先级
2. 条件要具体明确
3. 避免条件重叠
4. 定期检查规则冲突

### Q5: 规则执行顺序是什么？

**原则：**
- 按优先级从高到低执行
- 数字越大，优先级越高
- 优先级相同的规则按创建时间执行

---

## 六、技术支持

如有问题，请联系技术支持团队或查看系统日志。

---

## 附录：可用事实字段完整列表

### 运单相关事实

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `distance` | 数字 | 距离（公里） | `100` |
| `weight` | 数字 | 重量（公斤） | `500` |
| `volume` | 数字 | 体积（立方米） | `2.5` |
| `isHazardous` | 布尔值 | 是否危险品 | `true` |
| `weekendDelivery` | 布尔值 | 是否周末配送 | `false` |
| `customerLevel` | 字符串 | 客户级别 | `"vip"` |
| `pickupCity` | 字符串 | 取货城市 | `"北京"` |
| `deliveryCity` | 字符串 | 送货城市 | `"上海"` |
| `shipmentStatus` | 字符串 | 运单状态 | `"assigned"` |

### 司机相关事实（仅用于payroll规则）

| 字段名 | 类型 | 说明 | 示例值 |
|--------|------|------|--------|
| `driverLevel` | 字符串 | 司机等级 | `"senior"` |
| `driverRating` | 数字 | 司机评分 | `4.5` |
| `totalDeliveries` | 数字 | 总配送次数 | `100` |
| `onTimeRate` | 数字 | 准时率（0-100） | `95` |

---

**文档版本：** v1.0  
**最后更新：** 2025-11-30 07:00:00
