# TMS 5.0 需求规格说明书 (Requirements Specification)

**版本**: 5.1 (Refined for Workbench & Tracking)  
**日期**: 2026-01-08  
**状态**: 正式发布 (Effective)

---

## 1. 背景与目标 (Background & Objectives)

### 1.1 项目背景
本项目旨在从零构建一个现代化的 TMS（运输管理系统），通过全流程数字化解决现有业务中的调度效率低、在途不可视、结算繁琐等痛点。系统需整合最新的业务规划与架构设计结果，实现从“接单”到“对账”的完整闭环。

### 1.2 核心目标
1.  **调度效率提升**: 减少人工沟通，通过智能引擎辅助实现运单与资源的快速匹配，并提供直观的**可视化排程**。
2.  **全流程可视化 (Tracking P0)**: 实现运单状态（ETA、异常、证据链）的实时追踪，打造“单页闭环”的操作体验。
3.  **交付与结算准确性**: 确保回单（POD）、费用录入、调整项的精准记录，支持自动生成电子证据链。
4.  **工作台模式**: 为调度/运营提供统一的 Dashboard 入口，聚合核心指标与任务。

---

## 2. 用户与角色 (User Roles & RBAC)

| 角色 (Role) | 核心职责 | 关键权限 |
| :--- | :--- | :--- |
| **车队管理员 (Admin)** | 全局配置、系统管理 | 系统所有权限，包括人员/资产管理、审批流配置。 |
| **调度/运营 (Dispatcher)** | 运单全流程管理、异常处理 | 创建/分配/拆分运单，管理行程，即时通讯，改派。 |
| **财务 (Finance)** | 费用审核、对账结算 | 费用录入/修改，账单生成，发票/付款状态管理。 |
| **司机 (Driver)** | 执行运输任务 | (App端) 接单、签到、位置上报、上传回单、运单沟通。 |
| **客户 (Customer)** | 订单下单、进度查询 | (Portal端) 创建运单、查看进度、下载交付凭证。 |

---

## 3. 业务范围与流程 (Scope & Workflow)

### 3.1 核心业务实体关系
*   **运单 (Waybill)**: 客户下单的最小业务单元。
*   **行程 (Trip)**: 资源调度的最小执行单元。
*   **关系**: 1 Trip : N Waybill 模型，支持拼车与中转。

---

## 4. 详细功能需求 (Functional Requirements)

### 4.1 TMS 工作台 (TMS Workbench & Dashboard) [P0]
**目标**: 作为调度/运营人员的首页，聚合 P0 级核心指标与快捷入口。

#### 4.1.1 核心指标 (Metrics - P0)
*   **Total Trip/Order**: 总行程数、总运单数概览。
*   **On-time**: 准时率统计（如：95%）。
*   **Pending**: 待处理运单数（待调度、待确认）。
*   **Urgent**: 紧急任务/异常报警数。

#### 4.1.2 任务与历史 (Job List)
*   **Job History**: 最近运单/行程列表，支持快速搜索与筛选。
*   **快捷入口**: 新建运单、添加司机/车辆。

#### 4.1.3 高级报表 (Analytics - P1)
*   **Fleet Efficiency**: 平均交付时长趋势、平均里程统计。
*   **Job Completion Rate**: 完成率环形图。

---

### 4.2 智能追踪与闭环 (Tracking Loop) [P0]
**目标**: **单页闭环 (Single Page Loop)**。让调度在一页内完成所有操作：看状态、看路线、看 ETA、联系司机、发指令、留痕。

#### 4.2.1 状态闭环 (Status Bar - P0)
*   **状态流**: `Scheduled` -> `Confirmed` -> `On Route` -> `Arrived` -> `Delivered` -> `Complete`。
*   **溯源**: 每个状态节点需记录：**时间 (Timestamp)** + **操作者 (Actor)** + **来源 (Source)**（系统自动/人工修改/司机上报）。

#### 4.2.2 地图轨迹 (Map - P0)
*   **展示**: 起点、终点、司机当前位置的图标。
*   **路线**: 绘制规划路线的折线 (Polyline)。
*   **实时性**: 显示 Last update 时间戳（如 "Updated 5 mins ago"）。
*   *技术注*: MVP 阶段可集成 Google Maps SDK 或类似服务。

#### 4.2.3 核心信息卡片 (Info Cards - P0)
*   **ETA 卡片**:
    *   显示预计到达日期、时间。
    *   **倒计时**: 剩余时间（例如 "2 hrs 15 mins left"）。
    *   显示 ETA 最后更新时间。
*   **司机卡片 (Driver)**:
    *   姓名、电话。
    *   **Action**: 一键联系（支持点击拨号或复制电话）。
*   **车辆卡片 (Vehicle)**:
    *   Truck ID。
    *   **Load Info**: 当前载重、最大载重。(装载率可视化为 P1)。
*   **货物卡片 (Cargo)**:
    *   Cargo Type (如 Pork)。
    *   Count & Unit (如 200 heads / 20 pallets)。

#### 4.2.4 运单沟通与协同 (Chat & Logs - P0)
*   **即时通讯**: 运单内嵌聊天，支持发送文本消息。
*   **附件支持**:
    *   **P0**: 图片 (Images)、PDF。
    *   **P1**: DOCX / CSV / ZIP。
*   **事件标记 (P1)**: 聊天中的关键信息可标记为事件 (Event)，如 "Delay", "Confirm"，并同步到 Timeline。

---

### 4.3 运单管理 (Waybill Management) [P0]
#### 4.3.1 运单创建 (Order Entry)
*   **UI 标准**: **严格遵照亚马逊 Waybill 设计稿**。
*   **关键字段**: Fulfillment Center, PO#, PRO#, Pallet/Item Count, Origin/Dest (Tag支持), Time Window.
*   **附件**: 拖拽上传。

#### 4.3.2 运单列表
*   **资源列合并**: 司机 + 车辆同格展示。
*   **操作**: 指派 (Assign)、编辑 (Edit)、查看详情 (Detail)。
*   **PDF 生成**: 支持含电子签名的 PDF 导出。

---

### 4.4 车队与排程 (Fleet & Scheduling) [P1]
**注**: 整合原有“车队管理”并增强排程可视化。

#### 4.4.1 可视化排程 (Visual Scheduling - P1)
*   **视图**: **周视图 (Weekly)** 或 **日历视图 (Calendar)**。
*   **排序**: 基于 ETA 或 预约时间 (Appointment Time)。
*   **任务卡片 (Task Card)**:
    *   简要显示：货物类型、关键时间、状态 (e.g., "Pork - YYZ9 - On Route").
*   **交互 (P2)**: 支持拖拽卡片修改预约时间 (Drag & Drop rescheduling)。

#### 4.4.2 资源管理 (Resources - P0)
*   **综合视图**: 在途行程列表 + 空闲资源池 (司机/车辆)。
*   **添加资源**: 弹窗式便捷添加。
*   **资产档案**: 车辆属性 (VIN, Make, Load Capacity) 与 司机档案。

---

### 4.5 费用与结算 (Expenses & Settlement) [P0]
*   **计价**: Base Price + Adjustments (Fuel, Accessorials) = Total.
*   **证据链**: 费用项必须关联附件 (Receipts)。
*   **结算状态**: `Pending` / `Paid` / `Failed`。

---

### 4.6 其他模块
*   **Documentation (P1)**: 文档管理中心。
*   **Contract Management (P2)**: 合同生命周期管理。
*   **Messages (P0)**: 消息中心 (聚合通知)。
*   **Settings (P0)**: 系统设置与权限配置。

---

## 5. 数据需求与 NFR (Data & NFR)
*   **数据实体**: Company, Customer, Waybill (1:N), Trip, Driver, Vehicle, Message, Attachment.
*   **性能**: 列表查询 < 500ms (P95).
*   **移动端**: 司机 APP 需支持位置上报与照片上传。
*   **安全**: 附件访问鉴权。

---

## 6. 附录
*   参考: `uploaded_image_1767884583675.png` (Amazon Waybill Template)
